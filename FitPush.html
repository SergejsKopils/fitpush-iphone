<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<!-- PWA / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="FitPush" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

<title>FitPush</title>

<style>
:root{
  --bg:#000;
  --text:#fff;

  /* user prefs */
  --clock-scale:1.00;      /* 0.80..1.25 */
  --clock-bright:1.00;     /* 0.50..1.40 */
  --clock-glow:0.90;       /* 0.00..1.60 */
  --show-seconds:1;        /* 1 or 0 (used in JS only) */

  /* premium progress ring */
  --prog-opacity:.14;

  /* iOS safe */
  --safe-top: env(safe-area-inset-top);
  --safe-bot: env(safe-area-inset-bottom);
  --vh: 1vh; /* JS fallback */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* dynamic viewport (iOS) */
.viewport{
  position:fixed;
  inset:0;
  width:100%;
  height:100dvh;
  height:calc(var(--vh) * 100);
  overflow:hidden;
  background:#000;
}

/* slider */
.track{
  position:absolute; inset:0;
  display:flex;
  width:200%;
  height:100%;
  transform:translateX(0%);
  will-change:transform;
}
.screen{width:100%; height:100%; flex:0 0 100%; position:relative;}

/* ===== CLOCK ===== */
.clock{background:#000;}
.clock::before{
  content:""; position:absolute; inset:-30%;
  background:
    radial-gradient(circle at 50% 48%, rgba(255,255,255,.05) 0%, rgba(0,0,0,0) 34%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,.95) 62%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%, rgba(255,255,255,.01));
  opacity:.9; pointer-events:none;
}
.clock::after{
  content:""; position:absolute; inset:-40%;
  opacity:.06;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
  transform:rotate(12deg);
  pointer-events:none;
}

/* subtle ring inside safe areas */
.prog{
  position:absolute;
  inset:
    calc(12px + var(--safe-top))
    12px
    calc(12px + var(--safe-bot))
    12px;
  pointer-events:none;
  opacity: var(--prog-opacity);
  filter: drop-shadow(0 0 10px rgba(255,255,255,.04));
}
.prog svg{width:100%; height:100%}
.prog .bg{fill:none; stroke:rgba(255,255,255,.07); stroke-width:2.2;}
.prog .fg{fill:none; stroke:rgba(255,255,255,.55); stroke-width:2.2; stroke-linecap:round; opacity:.78; stroke-dasharray:1; stroke-dashoffset:0;}

.clock-center{
  position:absolute; inset:0;
  display:grid;
  place-items:center;
  padding:
    calc(18px + var(--safe-top))
    18px
    calc(18px + var(--safe-bot))
    18px;
}

/* stable iOS centering */
.clock-time{
  display:inline-block;
  transform: translate3d(0,0,0) scale(var(--clock-scale));
  transform-origin:center;
  filter: brightness(var(--clock-bright));
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-variant-numeric: tabular-nums;
  letter-spacing:.06em;
  line-height:1;
  text-align:center;
  color:#fff;
  -webkit-font-smoothing: antialiased;
  text-shadow:
    0 0 calc(18px * var(--clock-glow)) rgba(255,255,255,.18),
    0 0 calc(60px * var(--clock-glow)) rgba(255,255,255,.08);
  font-size: clamp(4.6rem, 18vw, 9.8rem);
}
.clock-time .sec{
  display:inline-block;
  font-size:.42em;
  opacity:.92;
  letter-spacing:.10em;
}

/* page dots */
.dots{
  position:absolute;
  left:50%;
  bottom: calc(12px + var(--safe-bot));
  transform:translateX(-50%);
  display:flex; gap:10px;
  opacity:.22;
}
.dot{width:6px; height:6px; border-radius:999px; background:#fff; opacity:.28;}
.dot.active{opacity:.92}

/* ===== SETTINGS ===== */
.settings{
  background:
    radial-gradient(circle at 50% -10%, rgba(255,255,255,.06), transparent 48%),
    radial-gradient(circle at 10% 90%, rgba(255,255,255,.04), transparent 40%),
    #000;
  height:100%;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 14px calc(14px + var(--safe-bot));
}

.header{
  position:sticky; top:0; z-index:5;
  padding: calc(12px + var(--safe-top)) 0 12px;
  background:linear-gradient(180deg, rgba(0,0,0,.94), rgba(0,0,0,.74) 70%, transparent);
  backdrop-filter: blur(10px);
}
.header-row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.title{font-size:1.05rem; letter-spacing:.12em; text-transform:uppercase; opacity:.92;}
.badge{
  font-size:.78rem; padding:7px 10px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:999px; color:rgba(255,255,255,.65);
  background:rgba(255,255,255,.03);
}

.cards{
  display:grid; gap:12px;
  max-width:820px;
  margin: 6px auto 0;
  padding-bottom: 18px;
}
.card{
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:rgba(255,255,255,.03);
  backdrop-filter: blur(10px);
  padding:14px;
}
.card h3{
  margin:0 0 10px;
  font-size:.95rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:rgba(255,255,255,.86);
}
.row{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:10px 0;
  border-top:1px solid rgba(255,255,255,.06);
}
.row:first-of-type{border-top:0}
.label{display:flex; flex-direction:column; gap:4px; min-width:0;}
.label .main{font-size:.95rem; color:rgba(255,255,255,.92);}
.label .sub{font-size:.80rem; color:rgba(255,255,255,.55); line-height:1.25;}
.controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

.switch{
  position:relative; width:46px; height:28px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.switch input{display:none}
.switch .knob{
  position:absolute; top:2px; left:2px;
  width:24px; height:24px; border-radius:999px;
  background:#fff; opacity:.86;
  transition:transform 160ms ease, opacity 160ms ease;
}
.switch input:checked + .knob{transform:translateX(18px); opacity:1}
.switch.on{border-color:rgba(255,255,255,.20); background:rgba(255,255,255,.10)}

.range{display:flex; align-items:center; gap:10px; min-width:260px;}
input[type="range"]{width:220px; accent-color:#fff;}
.val{
  font-variant-numeric: tabular-nums;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  color:rgba(255,255,255,.72);
  font-size:.86rem;
  width:46px;
  text-align:right;
}

.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.22)}

.preset-grid{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px;}
.preset{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:rgba(255,255,255,.9);
  padding:10px 10px;
  border-radius:14px;
  cursor:pointer;
  text-align:center;
}
.preset.active{background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.22)}

/* overlay + toast */
.overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; background:rgba(0,0,0,.78); backdrop-filter: blur(10px); z-index:20;}
.overlay.show{display:flex}
.modal{width:min(520px,100%); border:1px solid rgba(255,255,255,.14); border-radius:18px; background:rgba(255,255,255,.05); backdrop-filter: blur(14px); padding:16px;}
.modal h2{margin:0 0 8px;font-size:1.25rem}
.modal p{margin:4px 0;color:rgba(255,255,255,.86)}
.modal .hint{font-size:.92rem;color:rgba(255,255,255,.55)}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.toast{position:fixed; left:50%; bottom:calc(18px + var(--safe-bot)); transform:translateX(-50%); padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.75); color:rgba(255,255,255,.90); font-size:.84rem; display:none; z-index:30;}
.toast.show{display:block}

/* iOS A2HS helper */
.a2hs{
  position:fixed; inset:0;
  display:none; align-items:flex-end; justify-content:center;
  padding: 18px 16px calc(16px + var(--safe-bot));
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  z-index:40;
}
.a2hs.show{display:flex}
.a2hs-card{
  width:min(560px,100%);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  background:rgba(255,255,255,.06);
  backdrop-filter: blur(14px);
  padding:14px;
}
.a2hs-top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
.a2hs-title{font-size:1.02rem; letter-spacing:.08em; text-transform:uppercase; opacity:.92;}
.a2hs-text{margin:10px 0 12px; color:rgba(255,255,255,.78); line-height:1.35; font-size:.95rem;}
.a2hs-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
.small{font-size:.85rem; color:rgba(255,255,255,.60)}
kbd{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  border-radius:8px;
  padding:2px 6px;
}

@media (max-width:520px){
  .range{min-width:0}
  input[type="range"]{width:170px}
  .preset-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
}
</style>
</head>

<body>
<div class="viewport">
  <div class="track" id="track">

    <!-- CLOCK -->
    <section class="screen clock" aria-label="Clock">
      <div class="prog" aria-hidden="true">
        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
          <path class="bg"
            d="M8,18 Q8,8 18,8 L82,8 Q92,8 92,18 L92,82 Q92,92 82,92 L18,92 Q8,92 8,82 Z" />
          <path id="pfg" class="fg"
            d="M8,18 Q8,8 18,8 L82,8 Q92,8 92,18 L92,82 Q92,92 82,92 L18,92 Q8,92 8,82 Z" />
        </svg>
      </div>

      <div class="clock-center">
        <div id="clockTime" class="clock-time">60:00</div>
      </div>

      <div class="dots" aria-hidden="true">
        <div class="dot active" id="dot0"></div>
        <div class="dot" id="dot1"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="screen settings" id="settingsScreen" aria-label="Settings">
      <div class="header">
        <div class="header-row">
          <div class="title">Settings</div>
          <div class="badge" id="statusBadge">Ожидание</div>
        </div>
      </div>

      <div class="cards">

        <div class="card">
          <h3>Timer</h3>

          <div class="row">
            <div class="label">
              <div class="main">Interval presets</div>
              <div class="sub">Choose default countdown duration</div>
            </div>
            <div class="controls" style="width:100%">
              <div class="preset-grid" style="width:100%" id="presetGrid">
                <button class="preset" data-min="25">25m</button>
                <button class="preset" data-min="45">45m</button>
                <button class="preset active" data-min="60">60m</button>
                <button class="preset" data-min="90">90m</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Controls</div>
              <div class="sub">Start / pause / reset</div>
            </div>
            <div class="controls">
              <button class="btn primary" id="btnStart">Start</button>
              <button class="btn" id="btnPause">Pause</button>
              <button class="btn" id="btnReset">Reset</button>
              <button class="btn" id="btnNow">Now</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Clock display</h3>

          <div class="row">
            <div class="label">
              <div class="main">Show seconds</div>
              <div class="sub">MM:SS vs MM (no seconds)</div>
            </div>
            <div class="controls">
              <label class="switch" id="swSecondsWrap">
                <input type="checkbox" id="swSeconds" />
                <span class="knob"></span>
              </label>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Dial size</div>
              <div class="sub">Scale digits</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgScale" min="0.80" max="1.25" step="0.01" />
                <div class="val" id="valScale">1.00</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Brightness</div>
              <div class="sub">Adjust for day/night</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgBright" min="0.50" max="1.40" step="0.01" />
                <div class="val" id="valBright">1.00</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Glow</div>
              <div class="sub">Light around digits</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgGlow" min="0.00" max="1.60" step="0.01" />
                <div class="val" id="valGlow">0.90</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Notifications & stats</h3>

          <div class="row">
            <div class="label">
              <div class="main">Browser notifications</div>
              <div class="sub">Enable reminders (PWA recommended on iOS)</div>
            </div>
            <div class="controls">
              <button class="btn" id="btnNotif">Enable</button>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Stats</div>
              <div class="sub">Today / streak / push-ups</div>
            </div>
            <div class="controls" style="gap:8px">
              <div class="badge">Today: <b id="stToday">0</b></div>
              <div class="badge">Streak: <b id="stStreak">0</b></div>
              <div class="badge">Push: <b id="stPush">0</b></div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Back to clock</div>
              <div class="sub">Swipe right or tap button</div>
            </div>
            <div class="controls">
              <button class="btn primary" id="btnBack">Back</button>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Install (iPhone)</div>
              <div class="sub">Show “Add to Home Screen” help</div>
            </div>
            <div class="controls">
              <button class="btn" id="btnA2HS">How to add</button>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<!-- Reminder overlay -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="mTitle">Время размяться</h2>
    <p id="mDose"></p>
    <p id="mHint" class="hint"></p>
    <div class="modal-actions">
      <button class="btn primary" id="done">Сделано</button>
      <button class="btn" id="snooze">Отложить 5 мин</button>
      <button class="btn" id="skip">Пропустить</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- iOS A2HS helper -->
<div id="a2hs" class="a2hs" role="dialog" aria-modal="true">
  <div class="a2hs-card">
    <div class="a2hs-top">
      <div>
        <div class="a2hs-title">Add to Home Screen</div>
        <div class="small">iPhone / iPad (Safari)</div>
      </div>
      <button class="btn" id="a2hsClose">Close</button>
    </div>
    <div class="a2hs-text">
      1) Нажми кнопку <kbd>Share</kbd> (квадрат со стрелкой вверх)<br/>
      2) Прокрути и выбери <kbd>Add to Home Screen</kbd><br/>
      3) Нажми <kbd>Add</kbd><br/><br/>
      После установки запускай FitPush с иконки — режим будет как приложение (standalone).
    </div>
    <div class="a2hs-actions">
      <button class="btn primary" id="a2hsOk">OK</button>
      <button class="btn" id="a2hsDont">Don’t show again</button>
    </div>
  </div>
</div>

<script>
/* ========= iOS viewport fix ========= */
function setVh(){
  document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
}
setVh();
addEventListener("resize", setVh);
addEventListener("orientationchange", ()=>setTimeout(setVh, 80));

/* ========= Service Worker (PWA) ========= */
(function registerSW(){
  if(!("serviceWorker" in navigator)) return;
  const isSecure = location.protocol==="https:" || location.hostname==="localhost" || location.hostname==="127.0.0.1";
  if(!isSecure) return;
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
})();

/* ========= state ========= */
const KEY_STATS="fitpush_stats_v6";
const KEY_PREFS="fitpush_prefs_v6";
const KEY_A2HS="fitpush_a2hs_hide_v1";

const IS_IOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
const IS_STANDALONE=matchMedia("(display-mode: standalone)").matches || navigator.standalone===true;

const EX=[
  {n:"Отжимания",d:"10 повторов",h:"Ровный корпус, полная амплитуда.",p:10,m:1},
  {n:"Приседания",d:"15 повторов",h:"Пятки прижаты, колени по линии стоп.",m:1},
  {n:"Планка",d:"30 секунд",h:"Не прогибай поясницу.",m:1},
  {n:"Растяжка плеч",d:"45 секунд",h:"Плавно, без рывков.",m:1},
  {n:"Прогулка",d:"2 минуты",h:"Встань и пройдись по комнате.",m:2},
  {n:"Выпады",d:"8 на каждую сторону",h:"Контроль баланса и шага.",m:1}
];

const S={
  min:60,total:3600,left:3600,
  run:false,end:null,id:null,cur:null,
  stats:{today:0,push:0,streak:0,last:""},
  prefs:{showSeconds:true,scale:1.00,bright:1.00,glow:0.90}
};

function day(d=new Date()){return d.toISOString().slice(0,10)}
function saveStats(){localStorage.setItem(KEY_STATS,JSON.stringify(S.stats))}
function savePrefs(){localStorage.setItem(KEY_PREFS,JSON.stringify(S.prefs))}
function loadStats(){
  try{const raw=localStorage.getItem(KEY_STATS); if(raw) S.stats={...S.stats,...JSON.parse(raw)}}catch(_){}
  const t=day();
  if(S.stats.last && S.stats.last!==t){
    const y=new Date(); y.setDate(y.getDate()-1);
    S.stats.streak = (S.stats.last===day(y)) ? (S.stats.streak+1) : 0;
    S.stats.today=0; S.stats.push=0;
  }
  S.stats.last=t; saveStats();
}
function loadPrefs(){
  try{const raw=localStorage.getItem(KEY_PREFS); if(raw) S.prefs={...S.prefs,...JSON.parse(raw)}}catch(_){}
}

/* ========= dom ========= */
const track=document.getElementById("track");
const dot0=document.getElementById("dot0");
const dot1=document.getElementById("dot1");
const clockTime=document.getElementById("clockTime");
const statusBadge=document.getElementById("statusBadge");

const presetGrid=document.getElementById("presetGrid");
const btnStart=document.getElementById("btnStart");
const btnPause=document.getElementById("btnPause");
const btnReset=document.getElementById("btnReset");
const btnNow=document.getElementById("btnNow");
const btnBack=document.getElementById("btnBack");

const btnNotif=document.getElementById("btnNotif");
const stToday=document.getElementById("stToday");
const stStreak=document.getElementById("stStreak");
const stPush=document.getElementById("stPush");

const swSeconds=document.getElementById("swSeconds");
const swSecondsWrap=document.getElementById("swSecondsWrap");

const rgScale=document.getElementById("rgScale");
const rgBright=document.getElementById("rgBright");
const rgGlow=document.getElementById("rgGlow");
const valScale=document.getElementById("valScale");
const valBright=document.getElementById("valBright");
const valGlow=document.getElementById("valGlow");

const overlay=document.getElementById("overlay");
const mTitle=document.getElementById("mTitle");
const mDose=document.getElementById("mDose");
const mHint=document.getElementById("mHint");
const done=document.getElementById("done");
const snooze=document.getElementById("snooze");
const skip=document.getElementById("skip");
const toastEl=document.getElementById("toast");

/* A2HS */
const a2hs=document.getElementById("a2hs");
const btnA2HS=document.getElementById("btnA2HS");
const a2hsClose=document.getElementById("a2hsClose");
const a2hsOk=document.getElementById("a2hsOk");
const a2hsDont=document.getElementById("a2hsDont");

/* progress ring */
const pfg=document.getElementById("pfg");
const ringLen=pfg.getTotalLength();
pfg.style.strokeDasharray=String(ringLen);
pfg.style.strokeDashoffset=String(ringLen);

/* ========= page nav (spring snap) ========= */
let page=0, isAnimating=false;

function getTranslateXPct(){
  const st=getComputedStyle(track).transform;
  if(!st || st==="none") return -page*100;
  const m=st.match(/matrix\(([^)]+)\)/);
  if(!m) return -page*100;
  const parts=m[1].split(",").map(x=>parseFloat(x.trim()));
  const tx=parts[4]||0;
  return (tx / window.innerWidth) * 100;
}
function springTo(targetPct){
  if(isAnimating) return;
  isAnimating=true;

  const current=getTranslateXPct();
  const overshoot = targetPct + (current < targetPct ? 3.2 : -3.2);

  track.animate(
    [{transform:`translateX(${current}%)`},{transform:`translateX(${overshoot}%)`}],
    {duration:170, easing:"cubic-bezier(.18,.78,.32,1)", fill:"forwards"}
  ).onfinish=()=>{
    track.animate(
      [{transform:`translateX(${overshoot}%)`},{transform:`translateX(${targetPct}%)`}],
      {duration:230, easing:"cubic-bezier(.22,1,.36,1)", fill:"forwards"}
    ).onfinish=()=>{
      track.style.transform=`translateX(${targetPct}%)`;
      isAnimating=false;
    };
  };
}
function setPage(p, snap=true){
  page=Math.max(0,Math.min(1,p));
  dot0.classList.toggle("active", page===0);
  dot1.classList.toggle("active", page===1);
  const target=-page*100;
  snap ? springTo(target) : (track.style.transform=`translateX(${target}%)`);
}
btnBack.addEventListener("click", ()=>setPage(0,true));

/* swipe (x vs y separation for settings scroll) */
let startX=0,startY=0,dragging=false,lastDx=0,lockedAxis=null;
function isInteractive(el){return !!el.closest("button,a,input,textarea,select,label")}
function onStart(e){
  const t=e.touches?e.touches[0]:e;
  if(page===1 && isInteractive(t.target)) return;
  startX=t.clientX; startY=t.clientY;
  dragging=true; lastDx=0; lockedAxis=null;
  if(track.getAnimations) track.getAnimations().forEach(a=>a.cancel());
  isAnimating=false;
}
function onMove(e){
  if(!dragging) return;
  const t=e.touches?e.touches[0]:e;
  const dx=t.clientX-startX, dy=t.clientY-startY;

  if(!lockedAxis){
    if(Math.abs(dx)>10 || Math.abs(dy)>10) lockedAxis=(Math.abs(dx)>Math.abs(dy))?"x":"y";
    else return;
  }
  if(lockedAxis==="y"){ dragging=false; return; } // let settings scroll

  lastDx=dx;
  const base=-page*100;
  let pos = base + (dx/window.innerWidth)*100;
  pos = Math.max(-110, Math.min(10, pos));
  track.style.transform=`translateX(${pos}%)`;
  if(e.cancelable) e.preventDefault();
}
function onEnd(){
  if(!dragging) return;
  dragging=false;
  const threshold=Math.max(70, window.innerWidth*0.15);
  if(lastDx<-threshold) setPage(1,true);
  else if(lastDx>threshold) setPage(0,true);
  else setPage(page,true);
}
addEventListener("touchstart",onStart,{passive:true});
addEventListener("touchmove",onMove,{passive:false});
addEventListener("touchend",onEnd,{passive:true});
addEventListener("mousedown",onStart);
addEventListener("mousemove",onMove);
addEventListener("mouseup",onEnd);

/* ========= prefs ========= */
function applyPrefs(){
  swSeconds.checked=!!S.prefs.showSeconds;
  swSecondsWrap.classList.toggle("on", swSeconds.checked);

  rgScale.value=String(S.prefs.scale);
  rgBright.value=String(S.prefs.bright);
  rgGlow.value=String(S.prefs.glow);

  valScale.textContent=Number(S.prefs.scale).toFixed(2);
  valBright.textContent=Number(S.prefs.bright).toFixed(2);
  valGlow.textContent=Number(S.prefs.glow).toFixed(2);

  document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale));
  document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright));
  document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow));

  savePrefs();
  render();
}

/* ========= timer render ========= */
function fmtMM(s){return String(Math.floor(s/60)).padStart(2,"0")}
function fmtMMSS_plain(s){
  const m=Math.floor(s/60), x=s%60;
  return `${String(m).padStart(2,"0")}:${String(x).padStart(2,"0")}`;
}
function fmtMMSS_html(s){
  const m=Math.floor(s/60), x=s%60;
  return `${String(m).padStart(2,"0")}:<span class="sec">${String(x).padStart(2,"0")}</span>`;
}
function setProgress(){
  const ratio=Math.max(0,Math.min(1, 1-(S.left/Math.max(1,S.total))));
  pfg.style.strokeDashoffset=String(ringLen*(1-ratio));
  const op = S.run ? .16 : (S.left!==S.total ? .12 : .08);
  document.documentElement.style.setProperty("--prog-opacity", String(op));
}
function render(){
  if(S.prefs.showSeconds) clockTime.innerHTML=fmtMMSS_html(S.left);
  else clockTime.textContent=fmtMM(S.left);

  statusBadge.textContent = S.run ? "В работе" : (S.left!==S.total ? "Пауза" : "Ожидание");

  stToday.textContent=String(S.stats.today||0);
  stStreak.textContent=String(S.stats.streak||0);
  stPush.textContent=String(S.stats.push||0);

  setProgress();
  document.title=(S.run?fmtMMSS_plain(S.left)+" · ":"")+"FitPush";
}

function pick(min){
  S.min=min; S.total=min*60; S.left=S.total; S.end=null;
  if(S.id){clearInterval(S.id); S.id=null}
  S.run=false;
  presetGrid.querySelectorAll(".preset").forEach(b=>b.classList.toggle("active", Number(b.dataset.min)===min));
  render();
}
function start(){
  if(S.run) return;
  S.run=true;
  S.end=Date.now()+S.left*1000;
  S.id=setInterval(()=>{
    S.left=Math.max(0, Math.round((S.end-Date.now())/1000));
    render();
    if(S.left<=0){
      clearInterval(S.id); S.id=null;
      S.run=false;
      fire("timer");
    }
  },250);
  render();
}
function pause(){ if(!S.run) return; S.run=false; if(S.id){clearInterval(S.id); S.id=null} render(); }
function reset(){ pause(); S.left=S.total; render(); }

/* reminder */
function fire(src){
  S.cur=EX[Math.floor(Math.random()*EX.length)];
  mTitle.textContent=S.cur.n;
  mDose.textContent="Цель: "+S.cur.d;
  mHint.textContent=S.cur.h;
  overlay.classList.add("show");
  sound(); vib(); notify(S.cur.n+" - "+S.cur.d);
}
function doneAction(){
  if(!S.cur) return;
  S.stats.today+=1;
  if(S.cur.p) S.stats.push+=(S.cur.p||0);
  S.stats.last=day(); saveStats();
  S.cur=null; overlay.classList.remove("show");
  reset(); start();
}
function skipAction(){S.cur=null; overlay.classList.remove("show"); reset(); start();}
function snoozeAction(){S.cur=null; overlay.classList.remove("show"); S.left=300; S.total=Math.max(S.total,300); start();}

/* notif */
function sound(){
  try{
    const c=new(window.AudioContext||window.webkitAudioContext)(),t=c.currentTime;
    [[523,.16],[659,.16]].forEach((z,i)=>{
      const o=c.createOscillator(),g=c.createGain();
      o.type="triangle"; o.frequency.value=z[0];
      o.connect(g); g.connect(c.destination);
      g.gain.setValueAtTime(.10,t+i*.18);
      g.gain.exponentialRampToValueAtTime(.001,t+i*.18+z[1]);
      o.start(t+i*.18); o.stop(t+i*.18+z[1]);
    });
  }catch(_){}
}
function vib(){try{if("vibrate" in navigator) navigator.vibrate([140,80,140])}catch(_){}}
function toast(msg){toastEl.textContent=msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),2200)}
function askNotif(){
  if(!("Notification" in window)){toast("No Notification API"); return;}
  if(IS_IOS && !IS_STANDALONE){alert("На iPhone уведомления стабильнее в режиме PWA: добавь на экран Домой."); return;}
  if(Notification.permission==="default") Notification.requestPermission().finally(updateNotifBtn);
  else updateNotifBtn();
}
function updateNotifBtn(){
  if(!("Notification" in window)){btnNotif.textContent="Not supported"; btnNotif.disabled=true; return;}
  if(IS_IOS && !IS_STANDALONE){btnNotif.textContent="Use PWA (iOS)"; return;}
  btnNotif.textContent = (Notification.permission==="granted") ? "Enabled" :
                         (Notification.permission==="denied") ? "Blocked" : "Enable";
}
function notify(body){
  if("Notification" in window && Notification.permission==="granted"){
    new Notification("FitPush",{body,tag:"fitpush"});
  }
}

/* ========= A2HS helper (iOS) ========= */
function shouldShowA2HS(){
  if(!IS_IOS) return false;
  if(IS_STANDALONE) return false;
  return localStorage.getItem(KEY_A2HS) !== "1";
}
function openA2HS(){ a2hs.classList.add("show"); }
function closeA2HS(){ a2hs.classList.remove("show"); }

btnA2HS.addEventListener("click", openA2HS);
a2hsClose.addEventListener("click", closeA2HS);
a2hsOk.addEventListener("click", closeA2HS);
a2hsDont.addEventListener("click", ()=>{
  localStorage.setItem(KEY_A2HS,"1");
  closeA2HS();
});

/* ========= events ========= */
presetGrid.addEventListener("click",(e)=>{const b=e.target.closest(".preset"); if(!b) return; pick(Number(b.dataset.min));});
btnStart.addEventListener("click",start);
btnPause.addEventListener("click",pause);
btnReset.addEventListener("click",reset);
btnNow.addEventListener("click",()=>fire("manual"));
btnNotif.addEventListener("click",askNotif);

done.addEventListener("click",doneAction);
skip.addEventListener("click",()=>{S.cur=null; overlay.classList.remove("show"); reset(); start();});
snooze.addEventListener("click",()=>{S.cur=null; overlay.classList.remove("show"); S.left=300; S.total=Math.max(S.total,300); start();});

swSeconds.addEventListener("change",()=>{S.prefs.showSeconds=swSeconds.checked; swSecondsWrap.classList.toggle("on", swSeconds.checked); savePrefs(); render();});
rgScale.addEventListener("input",()=>{S.prefs.scale=Number(rgScale.value); valScale.textContent=S.prefs.scale.toFixed(2); document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale)); savePrefs();});
rgScale.addEventListener("change",render);
rgBright.addEventListener("input",()=>{S.prefs.bright=Number(rgBright.value); valBright.textContent=S.prefs.bright.toFixed(2); document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright)); savePrefs();});
rgBright.addEventListener("change",render);
rgGlow.addEventListener("input",()=>{S.prefs.glow=Number(rgGlow.value); valGlow.textContent=S.prefs.glow.toFixed(2); document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow)); savePrefs();});
rgGlow.addEventListener("change",render);

document.addEventListener("visibilitychange",()=>{
  if(document.visibilityState==="visible" && S.run && S.end){
    S.left=Math.max(0, Math.round((S.end-Date.now())/1000));
    if(S.left<=0){
      if(S.id){clearInterval(S.id); S.id=null}
      S.run=false; fire("timer");
    }
    render();
  }
});

/* ========= init ========= */
loadStats();
loadPrefs();
applyPrefs();
pick(60);
updateNotifBtn();
render();
setPage(0,false);

if(shouldShowA2HS()){
  // show after first paint
  setTimeout(openA2HS, 700);
}
</script>
</body>
</html>
