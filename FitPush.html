<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="FitPush" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="format-detection" content="telephone=no" />
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.webmanifest" />
<title>FitPush</title>

<style>
:root{
  --bg:#000;
  --text:#ffffff;
  --muted:rgba(255,255,255,.55);
  --muted2:rgba(255,255,255,.28);
  --line:rgba(255,255,255,.10);

  /* user prefs */
  --clock-scale: 1.00;   /* 0.80..1.25 */
  --clock-bright: 1.00;  /* 0.50..1.40 */
  --clock-glow: 0.90;    /* 0.00..1.60 */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  overflow:hidden;
  touch-action: pan-y; /* allow vertical scroll in settings */
}

/* 2-screen slider */
.viewport{
  position:fixed;
  inset:0;
  overflow:hidden;
  background:#000;
}

/* IMPORTANT: width 200%, move 0% or -100% */
.track{
  position:absolute;
  inset:0;
  display:flex;
  width:200%;
  height:100%;
  transform:translateX(0%);
  transition:transform 280ms ease;
  will-change:transform;
}

.screen{
  width:100%;
  height:100%;
  flex:0 0 100%;
  position:relative;
}

/* =========================
   SCREEN 1: CLOCK (pure black)
   ========================= */
.clock{
  background:#000;
}

/* subtle “poster-like” black texture */
.clock::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(circle at 50% 48%, rgba(255,255,255,.05) 0%, rgba(0,0,0,0) 34%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,.95) 62%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%, rgba(255,255,255,.01));
  opacity:.9;
  pointer-events:none;
}

.clock::after{
  content:"";
  position:absolute; inset:-40%;
  opacity:.06;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
  transform:rotate(12deg);
  pointer-events:none;
}

.clock-center{
  position:absolute; inset:0;
  display:grid;
  place-items:center;
  padding: calc(24px + env(safe-area-inset-top)) 24px calc(24px + env(safe-area-inset-bottom));
}

.clock-time{
  transform:scale(var(--clock-scale));
  filter:brightness(var(--clock-bright));
  transform-origin:center;

  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-variant-numeric: tabular-nums;
  letter-spacing:.10em;
  line-height:1;
  text-align:center;
  font-size: clamp(5rem, 20vw, 10.5rem);
  color:#fff;
  text-shadow:
    0 0 calc(18px * var(--clock-glow)) rgba(255,255,255,.18),
    0 0 calc(60px * var(--clock-glow)) rgba(255,255,255,.08);
}

.clock-time .sec{
  font-size:.42em;
  opacity:.92;
  letter-spacing:.14em;
}

/* page dots */
.dots{
  position:absolute;
  left:50%;
  bottom: max(14px, env(safe-area-inset-bottom));
  transform:translateX(-50%);
  display:flex;
  gap:10px;
  opacity:.28;
  user-select:none;
}
.dot{
  width:6px; height:6px;
  border-radius:999px;
  background:#fff;
  opacity:.35;
}
.dot.active{opacity:.95}

/* =========================
   SCREEN 2: SETTINGS (user friendly)
   ========================= */
.settings{
  background:
    radial-gradient(circle at 50% -10%, rgba(255,255,255,.06), transparent 48%),
    radial-gradient(circle at 10% 90%, rgba(255,255,255,.04), transparent 40%),
    #000;
  padding:calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

.header{
  position:sticky;
  top:0;
  z-index:5;
  padding:10px 0 12px;
  background:linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.70) 60%, transparent);
  backdrop-filter: blur(10px);
}

.header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.title{
  font-size:1.05rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  opacity:.92;
}
.badge{
  font-size:.78rem;
  padding:7px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  color:var(--muted);
  background:rgba(255,255,255,.03);
}

.cards{
  display:grid;
  gap:12px;
  max-width:820px;
  margin:0 auto;
  padding-bottom:24px;
}

.card{
  border:1px solid var(--line);
  border-radius:18px;
  background:rgba(255,255,255,.03);
  backdrop-filter: blur(10px);
  padding:14px;
}
.card h3{
  margin:0 0 10px;
  font-size:.95rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:rgba(255,255,255,.86);
}
.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 0;
  border-top:1px solid rgba(255,255,255,.06);
}
.row:first-of-type{border-top:0}
.row .label{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.row .label .main{
  font-size:.95rem;
  color:rgba(255,255,255,.92);
}
.row .label .sub{
  font-size:.80rem;
  color:var(--muted);
  line-height:1.25;
}
.controls{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

/* switches */
.switch{
  position:relative;
  width:46px;
  height:28px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  flex:0 0 auto;
}
.switch input{display:none}
.switch .knob{
  position:absolute;
  top:2px; left:2px;
  width:24px; height:24px;
  border-radius:999px;
  background:#fff;
  opacity:.86;
  transition:transform 160ms ease, opacity 160ms ease;
}
.switch input:checked + .knob{
  transform:translateX(18px);
  opacity:1;
}
.switch.on{
  border-color:rgba(255,255,255,.20);
  background:rgba(255,255,255,.10);
}

/* sliders */
.range{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:260px;
}
input[type="range"]{
  width:220px;
  accent-color:#fff;
}
.val{
  font-variant-numeric: tabular-nums;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  color:rgba(255,255,255,.72);
  font-size:.86rem;
  width:46px;
  text-align:right;
}

/* buttons */
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}
.btn.primary{
  background:rgba(255,255,255,.12);
  border-color:rgba(255,255,255,.22);
}
.btn.danger{
  background:rgba(255,255,255,.04);
  border-color:rgba(255,255,255,.10);
  color:rgba(255,255,255,.80);
}

/* presets */
.preset-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:8px;
}
.preset{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:rgba(255,255,255,.9);
  padding:10px 10px;
  border-radius:14px;
  cursor:pointer;
  text-align:center;
  font-variant-numeric: tabular-nums;
}
.preset.active{
  background:rgba(255,255,255,.12);
  border-color:rgba(255,255,255,.22);
}

/* overlay (reminder) */
.overlay{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  padding:16px;
  background:rgba(0,0,0,.78);
  backdrop-filter: blur(10px);
  z-index:20;
}
.overlay.show{display:flex}
.modal{
  width:min(520px, 100%);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  background:rgba(255,255,255,.05);
  backdrop-filter: blur(14px);
  padding:16px;
}
.modal h2{margin:0 0 8px;font-size:1.25rem}
.modal p{margin:4px 0;color:rgba(255,255,255,.86)}
.modal .hint{font-size:.92rem;color:var(--muted)}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.75);
  color:rgba(255,255,255,.90);
  font-size:.84rem;
  display:none;
  z-index:30;
}
.toast.show{display:block}

@media (max-width:520px){
  .range{min-width:0}
  input[type="range"]{width:170px}
  .preset-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
}
</style>
</head>

<body>
<div class="viewport" id="viewport">
  <div class="track" id="track">

    <!-- SCREEN 1: CLOCK -->
    <section class="screen clock" aria-label="Clock">
      <div class="clock-center">
        <div id="clockTime" class="clock-time">60:00</div>
      </div>

      <div class="dots" aria-hidden="true">
        <div class="dot active" id="dot0"></div>
        <div class="dot" id="dot1"></div>
      </div>
    </section>

    <!-- SCREEN 2: SETTINGS -->
    <section class="screen settings" aria-label="Settings" id="settingsScreen">
      <div class="header">
        <div class="header-row">
          <div class="title">Settings</div>
          <div class="badge" id="statusBadge">Ожидание</div>
        </div>
      </div>

      <div class="cards">

        <div class="card">
          <h3>Timer</h3>

          <div class="row">
            <div class="label">
              <div class="main">Interval presets</div>
              <div class="sub">Choose default countdown duration</div>
            </div>
            <div class="controls" style="width:100%">
              <div class="preset-grid" style="width:100%" id="presetGrid">
                <button class="preset" data-min="25">25m</button>
                <button class="preset" data-min="45">45m</button>
                <button class="preset active" data-min="60">60m</button>
                <button class="preset" data-min="90">90m</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Controls</div>
              <div class="sub">Start / pause / reset</div>
            </div>
            <div class="controls">
              <button class="btn primary" id="btnStart">Start</button>
              <button class="btn" id="btnPause">Pause</button>
              <button class="btn" id="btnReset">Reset</button>
              <button class="btn" id="btnNow">Now</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Clock display</h3>

          <div class="row">
            <div class="label">
              <div class="main">Show seconds</div>
              <div class="sub">MM:SS vs MM (no seconds)</div>
            </div>
            <div class="controls">
              <label class="switch" id="swSecondsWrap">
                <input type="checkbox" id="swSeconds" />
                <span class="knob"></span>
              </label>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Dial size</div>
              <div class="sub">Scale digits</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgScale" min="0.80" max="1.25" step="0.01" />
                <div class="val" id="valScale">1.00</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Brightness</div>
              <div class="sub">Adjust for day/night</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgBright" min="0.50" max="1.40" step="0.01" />
                <div class="val" id="valBright">1.00</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Glow</div>
              <div class="sub">Light around digits</div>
            </div>
            <div class="controls">
              <div class="range">
                <input type="range" id="rgGlow" min="0.00" max="1.60" step="0.01" />
                <div class="val" id="valGlow">0.90</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Notifications & stats</h3>

          <div class="row">
            <div class="label">
              <div class="main">Browser notifications</div>
              <div class="sub">Enable reminders (PWA recommended on iOS)</div>
            </div>
            <div class="controls">
              <button class="btn" id="btnNotif">Enable</button>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Stats</div>
              <div class="sub">Today / streak / push-ups</div>
            </div>
            <div class="controls" style="gap:8px">
              <div class="badge">Today: <b id="stToday">0</b></div>
              <div class="badge">Streak: <b id="stStreak">0</b></div>
              <div class="badge">Push: <b id="stPush">0</b></div>
            </div>
          </div>

          <div class="row">
            <div class="label">
              <div class="main">Back to clock</div>
              <div class="sub">Swipe right or tap button</div>
            </div>
            <div class="controls">
              <button class="btn primary" id="btnBack">Back</button>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<!-- Reminder overlay -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="mTitle">Время размяться</h2>
    <p id="mDose"></p>
    <p id="mHint" class="hint"></p>
    <div class="modal-actions">
      <button class="btn primary" id="done">Сделано</button>
      <button class="btn" id="snooze">Отложить 5 мин</button>
      <button class="btn" id="skip">Пропустить</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   STATE + STORAGE
   ========================= */
const KEY_STATS = "fitpush_stats_v3";
const KEY_PREFS = "fitpush_prefs_v3";

const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const IS_STANDALONE = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;

const EX = [
  {n:"Отжимания", d:"10 повторов", h:"Ровный корпус, полная амплитуда.", p:10, m:1},
  {n:"Приседания", d:"15 повторов", h:"Пятки прижаты, колени по линии стоп.", m:1},
  {n:"Планка", d:"30 секунд", h:"Не прогибай поясницу.", m:1},
  {n:"Растяжка плеч", d:"45 секунд", h:"Плавно, без рывков.", m:1},
  {n:"Прогулка", d:"2 минуты", h:"Встань и пройдись по комнате.", m:2},
  {n:"Выпады", d:"8 на каждую сторону", h:"Контроль баланса и шага.", m:1}
];

const S = {
  min:60,
  total:3600,
  left:3600,
  run:false,
  end:null,
  id:null,
  cur:null,
  stats:{today:0,push:0,streak:0,last:""},
  prefs:{
    showSeconds:true,
    scale:1.00,
    bright:1.00,
    glow:0.90
  }
};

function day(d=new Date()){ return d.toISOString().slice(0,10); }

function saveStats(){ localStorage.setItem(KEY_STATS, JSON.stringify(S.stats)); }
function loadStats(){
  try{
    const raw = localStorage.getItem(KEY_STATS);
    if(raw) S.stats = {...S.stats, ...JSON.parse(raw)};
  }catch(_){}
  const t = day();
  if(S.stats.last && S.stats.last !== t){
    const y=new Date(); y.setDate(y.getDate()-1);
    S.stats.streak = (S.stats.last === day(y)) ? (S.stats.streak + 1) : 0;
    S.stats.today = 0;
    S.stats.push = 0;
  }
  S.stats.last = t;
  saveStats();
}

function savePrefs(){ localStorage.setItem(KEY_PREFS, JSON.stringify(S.prefs)); }
function loadPrefs(){
  try{
    const raw = localStorage.getItem(KEY_PREFS);
    if(raw) S.prefs = {...S.prefs, ...JSON.parse(raw)};
  }catch(_){}
}

/* =========================
   DOM
   ========================= */
const track = document.getElementById("track");
const settingsScreen = document.getElementById("settingsScreen");

const dot0 = document.getElementById("dot0");
const dot1 = document.getElementById("dot1");

const clockTime = document.getElementById("clockTime");
const statusBadge = document.getElementById("statusBadge");

const presetGrid = document.getElementById("presetGrid");

const btnStart = document.getElementById("btnStart");
const btnPause = document.getElementById("btnPause");
const btnReset = document.getElementById("btnReset");
const btnNow   = document.getElementById("btnNow");
const btnBack  = document.getElementById("btnBack");

const btnNotif = document.getElementById("btnNotif");
const stToday  = document.getElementById("stToday");
const stStreak = document.getElementById("stStreak");
const stPush   = document.getElementById("stPush");

const swSeconds = document.getElementById("swSeconds");
const swSecondsWrap = document.getElementById("swSecondsWrap");

const rgScale = document.getElementById("rgScale");
const rgBright = document.getElementById("rgBright");
const rgGlow = document.getElementById("rgGlow");
const valScale = document.getElementById("valScale");
const valBright = document.getElementById("valBright");
const valGlow = document.getElementById("valGlow");

const overlay = document.getElementById("overlay");
const mTitle = document.getElementById("mTitle");
const mDose = document.getElementById("mDose");
const mHint = document.getElementById("mHint");
const done = document.getElementById("done");
const snooze = document.getElementById("snooze");
const skip = document.getElementById("skip");

const toastEl = document.getElementById("toast");

/* =========================
   PAGE NAV (fixed)
   ========================= */
let page = 0; // 0 clock, 1 settings

function setPage(p, animate=true){
  page = Math.max(0, Math.min(1, p));
  track.style.transition = animate ? "transform 280ms ease" : "none";

  // IMPORTANT: 0% or -100% (NOT -50%)
  track.style.transform = `translateX(${-page*100}%)`;

  dot0.classList.toggle("active", page===0);
  dot1.classList.toggle("active", page===1);
}

btnBack.addEventListener("click", ()=>setPage(0,true));

/* =========================
   SWIPE (stable on iOS)
   ========================= */
let startX=0, startY=0, dragging=false;
let lastDx=0;
let lockedAxis=null; // "x" or "y"

function isInteractive(el){
  return !!el.closest("button, a, input, textarea, select, label");
}

function onStart(e){
  const t = e.touches ? e.touches[0] : e;

  // if user started inside settings and on an interactive control -> don't hijack
  if(page===1 && isInteractive(t.target)) return;

  startX = t.clientX;
  startY = t.clientY;
  dragging = true;
  lastDx = 0;
  lockedAxis = null;
  track.style.transition = "none";
}

function onMove(e){
  if(!dragging) return;
  const t = e.touches ? e.touches[0] : e;

  const dx = t.clientX - startX;
  const dy = t.clientY - startY;

  if(!lockedAxis){
    if(Math.abs(dx) > 10 || Math.abs(dy) > 10){
      lockedAxis = (Math.abs(dx) > Math.abs(dy)) ? "x" : "y";
    }else{
      return;
    }
  }

  // if user scrolls vertically on settings -> allow scroll, stop drag
  if(lockedAxis === "y"){
    dragging = false;
    setPage(page, true);
    return;
  }

  lastDx = dx;

  const vw = window.innerWidth;
  const base = -page * 100;
  const deltaPercent = (dx / vw) * 100;
  const pos = base + deltaPercent;

  // small rubber band
  const clamped = Math.max(-100 - 12, Math.min(0 + 12, pos));
  track.style.transform = `translateX(${clamped}%)`;

  // prevent browser back gesture / overscroll jitter on iOS while horizontal dragging
  if(e.cancelable) e.preventDefault();
}

function onEnd(){
  if(!dragging) return;
  dragging = false;

  const threshold = Math.max(70, window.innerWidth * 0.15);

  if(lastDx < -threshold) setPage(1,true);
  else if(lastDx > threshold) setPage(0,true);
  else setPage(page,true);
}

document.addEventListener("touchstart", onStart, {passive:true});
document.addEventListener("touchmove", onMove, {passive:false});
document.addEventListener("touchend", onEnd, {passive:true});

document.addEventListener("mousedown", onStart);
document.addEventListener("mousemove", onMove);
document.addEventListener("mouseup", onEnd);

/* keyboard */
document.addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  if(e.code==="Space"){
    e.preventDefault();
    setPage(page===0 ? 1 : 0, true);
  }
  if(k==="arrowleft") setPage(0,true);
  if(k==="arrowright") setPage(1,true);

  if(k==="s"){ S.run ? pause() : start(); }
  if(k==="r"){ reset(); }
  if(k==="n"){ fire("manual"); }
  if(k==="escape"){ overlay.classList.remove("show"); }
});

/* =========================
   PREFS APPLY
   ========================= */
function applyPrefs(){
  swSeconds.checked = !!S.prefs.showSeconds;
  swSecondsWrap.classList.toggle("on", swSeconds.checked);

  rgScale.value = String(S.prefs.scale);
  rgBright.value = String(S.prefs.bright);
  rgGlow.value = String(S.prefs.glow);

  valScale.textContent = Number(S.prefs.scale).toFixed(2);
  valBright.textContent = Number(S.prefs.bright).toFixed(2);
  valGlow.textContent = Number(S.prefs.glow).toFixed(2);

  document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale));
  document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright));
  document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow));

  savePrefs();
  render();
}

/* =========================
   TIMER + RENDER
   ========================= */
function fmtMM(s){
  const m = Math.floor(s/60);
  return String(m).padStart(2,"0");
}
function fmtMMSS_plain(s){
  const m=Math.floor(s/60), x=s%60;
  return `${String(m).padStart(2,"0")}:${String(x).padStart(2,"0")}`;
}
function fmtMMSS_html(s){
  const m=Math.floor(s/60), x=s%60;
  return `${String(m).padStart(2,"0")}:<span class="sec">${String(x).padStart(2,"0")}</span>`;
}

function render(){
  // clock output
  if(S.prefs.showSeconds){
    clockTime.innerHTML = fmtMMSS_html(S.left);
  }else{
    clockTime.textContent = fmtMM(S.left);
  }

  // status badge
  if(S.run) statusBadge.textContent="В работе";
  else if(S.left!==S.total) statusBadge.textContent="Пауза";
  else statusBadge.textContent="Ожидание";

  // stats
  stToday.textContent = String(S.stats.today||0);
  stStreak.textContent = String(S.stats.streak||0);
  stPush.textContent = String(S.stats.push||0);

  document.title = (S.run ? fmtMMSS_plain(S.left)+" · " : "") + "FitPush";
}

function pick(min){
  S.min=min;
  S.total=min*60;
  S.left=S.total;
  S.end=null;
  if(S.id){ clearInterval(S.id); S.id=null; }
  S.run=false;

  presetGrid.querySelectorAll(".preset").forEach(b=>{
    b.classList.toggle("active", Number(b.dataset.min)===min);
  });

  render();
}

function start(){
  if(S.run) return;
  S.run=true;
  S.end=Date.now()+S.left*1000;

  S.id=setInterval(()=>{
    S.left=Math.max(0, Math.round((S.end - Date.now())/1000));
    render();
    if(S.left<=0){
      clearInterval(S.id); S.id=null;
      S.run=false;
      fire("timer");
    }
  }, 250);

  render();
}
function pause(){
  if(!S.run) return;
  S.run=false;
  if(S.id){ clearInterval(S.id); S.id=null; }
  render();
}
function reset(){
  pause();
  S.left=S.total;
  render();
}

/* =========================
   REMINDER
   ========================= */
function fire(src){
  S.cur = EX[Math.floor(Math.random()*EX.length)];
  mTitle.textContent = S.cur.n;
  mDose.textContent = "Цель: " + S.cur.d;
  mHint.textContent = S.cur.h;
  overlay.classList.add("show");
  sound(); vib(); notify(S.cur.n+" - "+S.cur.d);
}

function doneAction(){
  if(!S.cur) return;
  S.stats.today += 1;
  if(S.cur.p) S.stats.push += (S.cur.p||0);
  S.stats.last = day();
  saveStats();

  S.cur=null;
  overlay.classList.remove("show");
  reset(); start();
}
function skipAction(){
  S.cur=null;
  overlay.classList.remove("show");
  reset(); start();
}
function snoozeAction(){
  S.cur=null;
  overlay.classList.remove("show");
  S.left=300;
  S.total=Math.max(S.total,300);
  start();
}

/* =========================
   NOTIFS
   ========================= */
function sound(){
  try{
    const c=new(window.AudioContext||window.webkitAudioContext)(),t=c.currentTime;
    [[523,.16],[659,.16]].forEach((z,i)=>{
      const o=c.createOscillator(),g=c.createGain();
      o.type="triangle"; o.frequency.value=z[0];
      o.connect(g); g.connect(c.destination);
      g.gain.setValueAtTime(.10,t+i*.18);
      g.gain.exponentialRampToValueAtTime(.001,t+i*.18+z[1]);
      o.start(t+i*.18); o.stop(t+i*.18+z[1]);
    });
  }catch(_){}
}
function vib(){ try{ if("vibrate" in navigator) navigator.vibrate([140,80,140]); }catch(_){} }

function askNotif(){
  if(!("Notification" in window)) { toast("No Notification API"); return; }
  if(IS_IOS && !IS_STANDALONE){
    alert("На iPhone уведомления стабильнее в режиме PWA: добавь на экран Домой.");
    return;
  }
  if(Notification.permission==="default"){
    Notification.requestPermission().finally(updateNotifBtn);
  }else{
    updateNotifBtn();
  }
}
function updateNotifBtn(){
  if(!("Notification" in window)){ btnNotif.textContent="Not supported"; btnNotif.disabled=true; return; }
  if(IS_IOS && !IS_STANDALONE){ btnNotif.textContent="Use PWA (iOS)"; return; }
  if(Notification.permission==="granted") btnNotif.textContent="Enabled";
  else if(Notification.permission==="denied") btnNotif.textContent="Blocked";
  else btnNotif.textContent="Enable";
}
function notify(body){
  if("Notification" in window && Notification.permission==="granted"){
    new Notification("FitPush",{body,tag:"fitpush"});
  }
}

/* =========================
   TOAST + PWA
   ========================= */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 2200);
}

function pwa(){
  if(!("serviceWorker" in navigator)) return;
  const ok = location.protocol==="https:" || location.hostname==="localhost" || location.hostname==="127.0.0.1";
  if(ok) navigator.serviceWorker.register("./sw.js").catch(()=>{});
}

/* =========================
   EVENTS
   ========================= */
presetGrid.addEventListener("click",(e)=>{
  const b = e.target.closest(".preset");
  if(!b) return;
  pick(Number(b.dataset.min));
});

btnStart.addEventListener("click", start);
btnPause.addEventListener("click", pause);
btnReset.addEventListener("click", reset);
btnNow.addEventListener("click", ()=>fire("manual"));
btnNotif.addEventListener("click", askNotif);

done.addEventListener("click", doneAction);
skip.addEventListener("click", skipAction);
snooze.addEventListener("click", snoozeAction);

swSeconds.addEventListener("change", ()=>{
  S.prefs.showSeconds = swSeconds.checked;
  swSecondsWrap.classList.toggle("on", swSeconds.checked);
  savePrefs(); render();
});

rgScale.addEventListener("input", ()=>{
  S.prefs.scale = Number(rgScale.value);
  valScale.textContent = S.prefs.scale.toFixed(2);
  document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale));
  savePrefs();
});
rgScale.addEventListener("change", render);

rgBright.addEventListener("input", ()=>{
  S.prefs.bright = Number(rgBright.value);
  valBright.textContent = S.prefs.bright.toFixed(2);
  document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright));
  savePrefs();
});
rgBright.addEventListener("change", render);

rgGlow.addEventListener("input", ()=>{
  S.prefs.glow = Number(rgGlow.value);
  valGlow.textContent = S.prefs.glow.toFixed(2);
  document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow));
  savePrefs();
});
rgGlow.addEventListener("change", render);

/* keep timer correct after tab switch */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState==="visible" && S.run && S.end){
    S.left=Math.max(0, Math.round((S.end - Date.now())/1000));
    if(S.left<=0){
      if(S.id){clearInterval(S.id); S.id=null}
      S.run=false;
      fire("timer");
    }
    render();
  }
});

/* =========================
   INIT
   ========================= */
loadStats();
loadPrefs();
applyPrefs();
pick(60);
updateNotifBtn();
render();
pwa();
setPage(0,false);
</script>
</body>
</html>
