<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="FitPush" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="format-detection" content="telephone=no" />
<meta name="theme-color" content="#05070c" />
<link rel="manifest" href="manifest.webmanifest" />
<title>FitPush</title>

<style>
:root{
  --bg:#05070c;
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.09);
  --text:#f5f7fb;
  --muted:#9aa6bb;
  --warn:#fdba74;
  --danger:#fca5a5;

  /* user-tunable */
  --clock-scale: 1.0;      /* 0.8 .. 1.25 */
  --clock-bright: 1.0;     /* 0.5 .. 1.4 */
  --clock-glow: 1.0;       /* 0.0 .. 1.6 */
  --clock-vignette: .55;   /* 0 .. .75 */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font-family:"Segoe UI",Tahoma,sans-serif;
  background:
    radial-gradient(circle at 50% -12%, rgba(90,160,255,.18) 0%, transparent 46%),
    radial-gradient(circle at 12% 92%, rgba(60,120,160,.16) 0%, transparent 44%),
    #05070c;
  overflow:hidden;
}

/* subtle overlays */
body::before{
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.05) 0%, transparent 55%),
    linear-gradient(135deg, rgba(255,255,255,.02), transparent 44%);
  pointer-events:none;
}
body::after{
  content:"";
  position:fixed; inset:-40%;
  opacity:.08;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
  transform:rotate(10deg);
  pointer-events:none;
}

.app{height:100%}

/* ===== Screens routing ===== */
.screen{display:none; height:100%}
.screen.active{display:grid}

/* ===== CLOCK SCREEN ===== */
.screen-clock{
  grid-template-rows:auto 1fr auto;
  background:#000;
  padding:calc(8px + env(safe-area-inset-top)) 14px calc(10px + env(safe-area-inset-bottom));
}

.clock-shell{
  position:relative; width:100%; height:100%;
  outline:none; cursor:pointer; user-select:none;
}

/* full-screen dial option */
body.fullscreen-dial .clock-shell{
  width: 100vw;
  height: 100vh;
  max-height:none;
  border-radius:0;
  border-color: transparent;
  box-shadow:none;
}

.ios-status{
  display:flex; justify-content:space-between; align-items:center;
  padding:2px 2px 0; color:#f5f7fb; font-size:1.05rem; font-weight:700; letter-spacing:.01em;
}
.ios-icons{display:flex; gap:8px; align-items:center}
.sig{display:flex; gap:2px; align-items:flex-end}
.sig i{display:block; width:3px; border-radius:2px; background:#fff; opacity:.9}
.sig i:nth-child(1){height:4px}
.sig i:nth-child(2){height:6px}
.sig i:nth-child(3){height:8px}
.sig i:nth-child(4){height:10px}
.wifi{
  width:14px;height:10px;position:relative;display:block;
}
.wifi::before,.wifi::after{
  content:"";position:absolute;left:50%;transform:translateX(-50%);
  border:2px solid #fff;border-top-color:#fff;border-right-color:transparent;border-bottom-color:transparent;border-left-color:transparent;border-radius:50%;
}
.wifi::before{width:14px;height:14px;top:-7px}
.wifi::after{width:8px;height:8px;top:-4px}
.battery{
  width:26px;height:12px;border:2px solid #fff;border-radius:4px;position:relative;
}
.battery::before{
  content:"";position:absolute;right:-4px;top:2px;width:2px;height:6px;background:#fff;border-radius:1px;
}
.battery::after{
  content:"";position:absolute;left:2px;top:2px;width:16px;height:6px;background:#fff;border-radius:2px;
}

.clock-content{
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center;
  padding:24px 16px 52px;
  transform:scale(var(--clock-scale));
  filter:brightness(var(--clock-bright));
}

.brand-mark{
  font-size:clamp(3.6rem,18vw,8.8rem); font-weight:900; line-height:.84; letter-spacing:.01em;
  text-transform:uppercase; color:#f1f3f6;
  transform:skewY(-8deg);
  margin-top:-4vh;
}
.brand-mark span{display:block}

.clock-time{
  margin-top:26px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: clamp(2.1rem, 7vw, 3.5rem);
  letter-spacing:.18em; font-variant-numeric:tabular-nums; color:#f7fbff;
  text-shadow:0 0 calc(16px * var(--clock-glow)) rgba(255,255,255,.16);
}

/* seconds smaller */
.clock-time .sec{
  font-size: .45em;
  opacity:.92;
  letter-spacing:.12em;
}

.clock-hint{
  position:absolute;
  bottom:58px;
  left:50%;
  transform:translateX(-50%);
  font-size:.78rem;
  color:rgba(200,210,230,.38);
  letter-spacing:.06em;
}
.clock-hint b{color:rgba(230,240,255,.55); font-weight:600}
.home-indicator{
  position:absolute;left:50%;bottom:8px;transform:translateX(-50%);
  width:min(36vw,140px);height:5px;border-radius:999px;background:rgba(230,235,245,.55);
}

.clock-shell:active{transform:translateY(1px) scale(var(--clock-scale))}

/* ===== SETTINGS SCREEN ===== */
.screen-settings{
  grid-template-rows:auto 1fr auto;
  gap:14px;
  padding:calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
  max-width:980px;
  margin:0 auto;
}

.top{display:flex;justify-content:space-between;align-items:center;gap:10px}
.brand{font-size:.95rem;letter-spacing:.16em;text-transform:uppercase;color:#dbe6ff}
.status{font-size:.72rem;color:var(--muted);border:1px solid var(--line2);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.03);backdrop-filter:blur(10px)}

.stage{display:flex;align-items:center;justify-content:center;min-height:0}
.dial-wrap{position:relative;width:min(76vw,560px);aspect-ratio:1/1;display:grid;place-items:center}
.dial-glow{position:absolute;inset:9%;border-radius:50%;filter:blur(28px);background:radial-gradient(circle,rgba(170,220,255,.14) 0%,transparent 70%)}
.dial{position:relative;width:100%;height:100%;border-radius:50%;border:1px solid var(--line);
  background:linear-gradient(165deg,rgba(255,255,255,.12),rgba(255,255,255,.03) 50%,rgba(0,0,0,.18)),
  radial-gradient(circle at 30% 25%,rgba(255,255,255,.10),transparent 56%);
  backdrop-filter:blur(16px) saturate(125%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 40px 90px rgba(0,0,0,.50)
}
.ring{position:absolute;inset:6.5%;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:rgba(255,255,255,.08);stroke-width:8}
.ring-fg{fill:none;stroke:rgba(190,225,255,.88);stroke-width:8;stroke-linecap:round;filter:drop-shadow(0 0 10px rgba(170,220,255,.22));transition:stroke-dashoffset .22s linear}
.tick{position:absolute;inset:10%;border-radius:50%;
  background:repeating-conic-gradient(from 0deg,rgba(255,255,255,.18) 0deg 1deg,transparent 1deg 8deg);
  mask:radial-gradient(circle,transparent 74%,#000 75%);
  opacity:.55
}
.core{position:absolute;inset:21%;border-radius:50%;border:1px solid rgba(255,255,255,.13);
  background:radial-gradient(circle at 40% 20%,rgba(255,255,255,.16),rgba(255,255,255,.03) 45%,rgba(0,0,0,.20));
  backdrop-filter:blur(12px) saturate(120%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:14px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)
}
.phase{font-size:.72rem;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
.timeMirror{margin:10px 0 6px;font-size:clamp(2.8rem,10vw,5.8rem);line-height:1;font-variant-numeric:tabular-nums;letter-spacing:.05em;color:var(--text)}
.next{font-size:.78rem;color:#c7d6ea;min-height:18px;opacity:.92}

.bottom{display:grid;gap:10px}
.controls,.presets,.meta,.prefs{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;user-select:none}

button{
  font:inherit;
  border:1px solid var(--line2);
  background:rgba(255,255,255,.05);
  color:var(--text);
  padding:10px 14px;
  border-radius:14px;
  cursor:pointer;
  backdrop-filter:blur(10px)
}
button:active{transform:translateY(1px)}
.btn-main{background:linear-gradient(135deg,rgba(190,225,255,.22),rgba(255,255,255,.05));border-color:rgba(190,225,255,.35)}
.presets button{font-size:.86rem;padding:8px 11px;color:#d8e5f7}
.presets button.active{background:rgba(190,225,255,.16);border-color:rgba(190,225,255,.38)}
.meta{color:var(--muted);font-size:.78rem}
.chip{border:1px solid var(--line2);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.035);backdrop-filter:blur(10px)}

/* Preferences panel */
.prefs{
  margin-top:6px;
  padding:10px 10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  backdrop-filter: blur(10px);
}
.pref{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(0,0,0,.08);
}
.pref label{
  font-size:.82rem;
  color:rgba(210,225,245,.85);
  letter-spacing:.02em;
}
.pref input[type="range"]{
  width:140px;
}
.pref input[type="checkbox"]{
  transform:scale(1.1);
}
.small{
  font-size:.75rem;
  color:rgba(190,205,230,.70);
}

/* Overlay modal */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(2,6,14,.72);backdrop-filter:blur(10px)}
.overlay.show{display:flex}
.modal{width:min(460px,100%);border:1px solid var(--line);border-radius:18px;background:linear-gradient(165deg,rgba(255,255,255,.14),rgba(255,255,255,.05));backdrop-filter:blur(14px);padding:16px}
.modal h2{margin:0 0 8px;font-size:1.25rem}
.modal p{margin:4px 0;color:#d8e5f7}
.modal .hint{font-size:.9rem;color:var(--muted)}
.modal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

/* Toast */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 12px;border-radius:999px;border:1px solid #2b3a4a;background:rgba(8,16,28,.86);color:#d8e5f7;font-size:.82rem;display:none}
.toast.show{display:block}

@media (max-width:640px){
  .screen-settings{padding:calc(12px + env(safe-area-inset-top)) 10px calc(12px + env(safe-area-inset-bottom))}
  .dial-wrap{width:min(92vw,430px)}
  .core{inset:22%}
  .timeMirror{font-size:clamp(2.4rem,14vw,4.6rem)}
  .clock-shell{height:min(50vw,280px); border-radius:38px}
  .pref input[type="range"]{width:110px}
}
</style>
</head>

<body>
<div class="app">

  <!-- SCREEN 1: CLOCK -->
  <section id="screenClock" class="screen screen-clock active" aria-label="Clock screen">
    <div class="ios-status">
      <div id="statusClock">9:41</div>
      <div class="ios-icons" aria-hidden="true">
        <span class="sig"><i></i><i></i><i></i><i></i></span>
        <span class="wifi"></span>
        <span class="battery"></span>
      </div>
    </div>
    <div class="clock-shell" id="openSettings" tabindex="0" role="button" aria-label="Open settings">
      <div class="clock-content">
        <div class="brand-mark" aria-hidden="true"><span>FIT</span><span>PUSH</span></div>
        <div id="time" class="clock-time">60:00</div>
        <div class="clock-hint">press <b>Space</b> for settings</div>
      </div>
      <div class="home-indicator" aria-hidden="true"></div>
    </div>
  </section>

  <!-- SCREEN 2: SETTINGS -->
  <section id="screenSettings" class="screen screen-settings" aria-label="Settings screen">

    <div class="top">
      <div class="brand">FitPush</div>
      <div id="status" class="status">Ожидание</div>
    </div>

    <div class="stage">
      <div class="dial-wrap">
        <div class="dial-glow"></div>
        <div class="dial">
          <svg class="ring" viewBox="0 0 200 200" aria-hidden="true">
            <circle class="ring-bg" cx="100" cy="100" r="88"></circle>
            <circle id="ringFg" class="ring-fg" cx="100" cy="100" r="88"></circle>
          </svg>
          <div class="tick"></div>
          <div class="core">
            <div id="phase" class="phase">До разминки</div>
            <div id="timeMirror" class="timeMirror">60:00</div>
            <div id="next" class="next">Выбери интервал и нажми Старт</div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <div class="controls">
        <button id="start" class="btn-main">Старт</button>
        <button id="pause">Пауза</button>
        <button id="reset">Сброс</button>
        <button id="now">Сейчас</button>
        <button id="notif">Уведомления</button>
        <button id="backClock">На часы</button>
      </div>

      <div id="presets" class="presets">
        <button data-min="25">25м</button>
        <button data-min="45">45м</button>
        <button data-min="60" class="active">60м</button>
        <button data-min="90">90м</button>
      </div>

      <!-- Preferences -->
      <div class="prefs" aria-label="Clock preferences">
        <div class="pref">
          <input id="showSeconds" type="checkbox" />
          <label for="showSeconds">Показывать секунды</label>
        </div>

        <div class="pref">
          <label for="dialFullscreen">Циферблат на весь экран</label>
          <input id="dialFullscreen" type="checkbox" />
        </div>

        <div class="pref">
          <label for="scaleRange">Размер</label>
          <input id="scaleRange" type="range" min="0.80" max="1.25" step="0.01" />
          <span id="scaleVal" class="small"></span>
        </div>

        <div class="pref">
          <label for="brightRange">Яркость</label>
          <input id="brightRange" type="range" min="0.50" max="1.40" step="0.01" />
          <span id="brightVal" class="small"></span>
        </div>

        <div class="pref">
          <label for="glowRange">Свечение</label>
          <input id="glowRange" type="range" min="0.00" max="1.60" step="0.01" />
          <span id="glowVal" class="small"></span>
        </div>
      </div>

      <div class="meta">
        <span class="chip">Сегодня: <b id="stToday">0</b></span>
        <span class="chip">Стрик: <b id="stStreak">0</b></span>
        <span class="chip">Отжиманий: <b id="stPush">0</b></span>
      </div>
    </div>
  </section>
</div>

<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="mTitle">Время размяться</h2>
    <p id="mDose"></p>
    <p id="mHint" class="hint"></p>
    <div class="modal-actions">
      <button id="done" class="btn-main">Сделано</button>
      <button id="snooze">Отложить 5 мин</button>
      <button id="skip">Пропустить</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const KEY_STATS="fitpush_stats_v1";
const KEY_PREFS="fitpush_clock_prefs_v1";
const IS_IOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
const IS_STANDALONE=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===true;

const EX=[
  {n:"Отжимания",d:"10 повторов",h:"Ровный корпус, полная амплитуда.",p:10,m:1},
  {n:"Приседания",d:"15 повторов",h:"Пятки прижаты, колени по линии стоп.",m:1},
  {n:"Планка",d:"30 секунд",h:"Не прогибай поясницу.",m:1},
  {n:"Растяжка плеч",d:"45 секунд",h:"Плавно, без рывков.",m:1},
  {n:"Прогулка",d:"2 минуты",h:"Встань и пройдись по комнате.",m:2},
  {n:"Выпады",d:"8 на каждую сторону",h:"Контроль баланса и шага.",m:1}
];

const S={
  min:60,total:3600,left:3600,
  run:false,end:null,id:null,cur:null,
  stats:{today:0,push:0,streak:0,last:""},
  prefs:{
    showSeconds:false,
    fullscreen:false,
    scale:1.00,
    bright:1.00,
    glow:1.00
  }
};

const E={
  // Screens
  screenClock: document.getElementById("screenClock"),
  screenSettings: document.getElementById("screenSettings"),
  openSettings: document.getElementById("openSettings"),
  backClock: document.getElementById("backClock"),

  // Clock output
  statusClock: document.getElementById("statusClock"),
  time: document.getElementById("time"),
  timeMirror: document.getElementById("timeMirror"),

  // Main UI
  status: document.getElementById("status"),
  phase: document.getElementById("phase"),
  next: document.getElementById("next"),
  ring: document.getElementById("ringFg"),
  start: document.getElementById("start"),
  pause: document.getElementById("pause"),
  reset: document.getElementById("reset"),
  now: document.getElementById("now"),
  notif: document.getElementById("notif"),
  presets: document.getElementById("presets"),
  stToday: document.getElementById("stToday"),
  stPush: document.getElementById("stPush"),
  stStreak: document.getElementById("stStreak"),

  // prefs
  showSeconds: document.getElementById("showSeconds"),
  dialFullscreen: document.getElementById("dialFullscreen"),
  scaleRange: document.getElementById("scaleRange"),
  brightRange: document.getElementById("brightRange"),
  glowRange: document.getElementById("glowRange"),
  scaleVal: document.getElementById("scaleVal"),
  brightVal: document.getElementById("brightVal"),
  glowVal: document.getElementById("glowVal"),

  // overlay
  overlay: document.getElementById("overlay"),
  mTitle: document.getElementById("mTitle"),
  mDose: document.getElementById("mDose"),
  mHint: document.getElementById("mHint"),
  done: document.getElementById("done"),
  snooze: document.getElementById("snooze"),
  skip: document.getElementById("skip"),
  toast: document.getElementById("toast")
};

const CIRC=2*Math.PI*88;
E.ring.setAttribute("stroke-dasharray",String(CIRC));

/* ===== Helpers ===== */
function fmtMMSS(s){
  const m=Math.floor(s/60),x=s%60;
  return String(m).padStart(2,"0")+":"+String(x).padStart(2,"0");
}
function fmtMMSS_withSeconds(s){
  // same as MM:SS, but we wrap seconds to style smaller
  const m=Math.floor(s/60),x=s%60;
  const mm=String(m).padStart(2,"0");
  const ss=String(x).padStart(2,"0");
  return `${mm}:<span class="sec">${ss}</span>`;
}
function day(d=new Date()){return d.toISOString().slice(0,10)}
function nowHM(){
  return new Date().toLocaleTimeString([], {hour:"numeric", minute:"2-digit"});
}

/* ===== Storage ===== */
function saveStats(){ localStorage.setItem(KEY_STATS, JSON.stringify(S.stats)); }
function loadStats(){
  try{
    const x=localStorage.getItem(KEY_STATS);
    if(x) S.stats={...S.stats,...JSON.parse(x)};
  }catch(_){}
  const t=day();
  if(S.stats.last && S.stats.last!==t){
    const y=new Date(); y.setDate(y.getDate()-1);
    S.stats.streak = (S.stats.last===day(y)) ? (S.stats.streak+1) : 0;
    S.stats.today=0; S.stats.push=0;
  }
  S.stats.last=t;
  saveStats();
}

function savePrefs(){ localStorage.setItem(KEY_PREFS, JSON.stringify(S.prefs)); }
function loadPrefs(){
  try{
    const x=localStorage.getItem(KEY_PREFS);
    if(x){
      const p=JSON.parse(x);
      S.prefs={...S.prefs,...p};
    }
  }catch(_){}
}

/* ===== UI: screens ===== */
function showClock(){
  E.screenClock.classList.add("active");
  E.screenSettings.classList.remove("active");
}
function showSettings(){
  E.screenSettings.classList.add("active");
  E.screenClock.classList.remove("active");
}

/* ===== Apply prefs to UI ===== */
function applyPrefs(){
  // seconds
  E.showSeconds.checked = !!S.prefs.showSeconds;

  // fullscreen dial
  E.dialFullscreen.checked = !!S.prefs.fullscreen;
  document.body.classList.toggle("fullscreen-dial", !!S.prefs.fullscreen);

  // scale/brightness/glow -> CSS variables
  document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale));
  document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright));
  document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow));

  // sliders
  E.scaleRange.value = String(S.prefs.scale);
  E.brightRange.value = String(S.prefs.bright);
  E.glowRange.value = String(S.prefs.glow);

  E.scaleVal.textContent = Number(S.prefs.scale).toFixed(2);
  E.brightVal.textContent = Number(S.prefs.bright).toFixed(2);
  E.glowVal.textContent = Number(S.prefs.glow).toFixed(2);

  savePrefs();
  render(); // refresh time formatting
}

/* ===== Render ===== */
function render(){
  // time output based on preference
  if(S.prefs.showSeconds){
    E.time.innerHTML = fmtMMSS_withSeconds(S.left);
  }else{
    E.time.textContent = fmtMMSS(S.left);
  }

  // mirror time in settings (plain text is fine)
  E.timeMirror.textContent = fmtMMSS(S.left);

  // ring progress
  const r=Math.max(0,Math.min(1,1-S.left/S.total));
  E.ring.style.strokeDashoffset=String(CIRC*(1-r));

  // status
  if(S.run) E.status.textContent="В работе";
  else if(S.left!==S.total) E.status.textContent="Пауза";
  else E.status.textContent="Ожидание";

  // urgency coloring only in settings
  if(S.left<=60) E.timeMirror.style.color="var(--danger)";
  else if(S.left<=300) E.timeMirror.style.color="var(--warn)";
  else E.timeMirror.style.color="var(--text)";

  // stats
  E.stToday.textContent=String(S.stats.today||0);
  E.stPush.textContent=String(S.stats.push||0);
  E.stStreak.textContent=String(S.stats.streak||0);
  E.statusClock.textContent = nowHM();

  document.title=(S.run?fmtMMSS(S.left)+" - ":"")+"FitPush";
}

/* ===== Timer logic ===== */
function pick(min){
  S.min=min;
  S.total=min*60;
  S.left=S.total;
  S.end=null;

  if(S.id){clearInterval(S.id);S.id=null}
  S.run=false;

  Array.from(E.presets.querySelectorAll("button")).forEach(b=>{
    b.classList.toggle("active", Number(b.dataset.min)===min);
  });

  E.phase.textContent="До разминки";
  E.next.textContent="Интервал: "+min+" минут";
  render();
}

function start(){
  if(S.run) return;
  S.run=true;
  S.end=Date.now()+S.left*1000;
  E.phase.textContent="До разминки";

  S.id=setInterval(()=>{
    S.left=Math.max(0,Math.round((S.end-Date.now())/1000));
    render();
    if(S.left<=0){
      clearInterval(S.id);S.id=null;
      S.run=false;
      fire("timer");
    }
  }, 250);

  render();
}
function pause(){
  if(!S.run) return;
  S.run=false;
  if(S.id){clearInterval(S.id);S.id=null}
  render();
}
function reset(){
  pause();
  S.left=S.total;
  E.phase.textContent="До разминки";
  E.next.textContent="Интервал: "+S.min+" минут";
  render();
}

/* ===== Toast ===== */
function toast(msg){
  E.toast.textContent=msg;
  E.toast.classList.add("show");
  setTimeout(()=>E.toast.classList.remove("show"), 2200);
}

/* ===== Reminder modal ===== */
function fire(src){
  S.cur=EX[Math.floor(Math.random()*EX.length)];
  E.mTitle.textContent=S.cur.n;
  E.mDose.textContent="Цель: "+S.cur.d;
  E.mHint.textContent=S.cur.h;
  E.next.textContent="Сейчас: "+S.cur.n;
  E.phase.textContent="Разминка";
  E.overlay.classList.add("show");
  sound(); vib(); notify(S.cur.n+" - "+S.cur.d);
}
function done(){
  if(!S.cur) return;
  S.stats.today+=1;
  if(S.cur.p) S.stats.push+=(S.cur.p||0);
  S.stats.last=day();
  saveStats();
  S.cur=null;
  E.overlay.classList.remove("show");
  reset(); start();
}
function skip(){
  S.cur=null;
  E.overlay.classList.remove("show");
  reset(); start();
}
function snooze(){
  S.cur=null;
  E.overlay.classList.remove("show");
  S.left=300;
  S.total=Math.max(S.total,300);
  E.phase.textContent="Отложено";
  E.next.textContent="Напоминание через 5 минут";
  start();
}

/* ===== Notifications ===== */
function sound(){
  try{
    const c=new(window.AudioContext||window.webkitAudioContext)(),t=c.currentTime;
    [[523,.16],[659,.16]].forEach((z,i)=>{
      const o=c.createOscillator(),g=c.createGain();
      o.type="triangle"; o.frequency.value=z[0];
      o.connect(g); g.connect(c.destination);
      g.gain.setValueAtTime(.10,t+i*.18);
      g.gain.exponentialRampToValueAtTime(.001,t+i*.18+z[1]);
      o.start(t+i*.18); o.stop(t+i*.18+z[1]);
    });
  }catch(_){}
}
function vib(){try{if("vibrate" in navigator)navigator.vibrate([140,80,140])}catch(_){}}

function askNotif(){
  if(!("Notification" in window)) return;
  if(IS_IOS && !IS_STANDALONE){
    alert("На iPhone сначала добавь приложение на экран Домой.");
    return;
  }
  if(Notification.permission==="default") Notification.requestPermission().finally(updNotif);
  else updNotif();
}
function updNotif(){
  if(!("Notification" in window)){ E.notif.textContent="Нет API"; E.notif.disabled=true; return; }
  if(IS_IOS && !IS_STANDALONE){ E.notif.textContent="Через Домой"; return; }
  if(Notification.permission==="granted") E.notif.textContent="Включено";
  else if(Notification.permission==="denied") E.notif.textContent="Блок";
  else E.notif.textContent="Уведомления";
}
function notify(body){
  if("Notification" in window && Notification.permission==="granted"){
    new Notification("FitPush",{body,tag:"fitpush"});
  }
}

/* ===== PWA ===== */
function pwa(){
  if(!("serviceWorker" in navigator)) return;
  const ok=location.protocol==="https:" || location.hostname==="localhost" || location.hostname==="127.0.0.1";
  if(ok) navigator.serviceWorker.register("./sw.js").catch(()=>{});
}

/* ===== Wire UI events ===== */
E.presets.addEventListener("click", e=>{
  const b=e.target.closest("button[data-min]");
  if(!b) return;
  pick(Number(b.dataset.min));
});
E.start.addEventListener("click", start);
E.pause.addEventListener("click", pause);
E.reset.addEventListener("click", reset);
E.now.addEventListener("click", ()=>fire("manual"));
E.notif.addEventListener("click", askNotif);
E.done.addEventListener("click", done);
E.skip.addEventListener("click", skip);
E.snooze.addEventListener("click", snooze);

/* Screens */
E.openSettings.addEventListener("click", showSettings);
E.backClock.addEventListener("click", showClock);

/* Preferences events */
E.showSeconds.addEventListener("change", ()=>{
  S.prefs.showSeconds = E.showSeconds.checked;
  savePrefs(); render();
});
E.dialFullscreen.addEventListener("change", ()=>{
  S.prefs.fullscreen = E.dialFullscreen.checked;
  applyPrefs();
});
E.scaleRange.addEventListener("input", ()=>{
  S.prefs.scale = Number(E.scaleRange.value);
  E.scaleVal.textContent = Number(S.prefs.scale).toFixed(2);
  document.documentElement.style.setProperty("--clock-scale", String(S.prefs.scale));
  savePrefs();
});
E.scaleRange.addEventListener("change", render);

E.brightRange.addEventListener("input", ()=>{
  S.prefs.bright = Number(E.brightRange.value);
  E.brightVal.textContent = Number(S.prefs.bright).toFixed(2);
  document.documentElement.style.setProperty("--clock-bright", String(S.prefs.bright));
  savePrefs();
});
E.brightRange.addEventListener("change", render);

E.glowRange.addEventListener("input", ()=>{
  S.prefs.glow = Number(E.glowRange.value);
  E.glowVal.textContent = Number(S.prefs.glow).toFixed(2);
  document.documentElement.style.setProperty("--clock-glow", String(S.prefs.glow));
  savePrefs();
});
E.glowRange.addEventListener("change", render);

/* Keyboard shortcuts:
   Space = toggle screens
   S = start/pause
   R = reset
   N = manual reminder
   F = toggle full-screen dial
   Esc = close overlay
*/
document.addEventListener("keydown", e=>{
  const k=e.key.toLowerCase();

  if(e.code==="Space"){
    e.preventDefault();
    if(E.screenClock.classList.contains("active")) showSettings();
    else showClock();
  }
  if(k==="s"){ S.run ? pause() : start(); }
  if(k==="r"){ reset(); }
  if(k==="n"){ fire("manual"); }
  if(k==="f"){
    S.prefs.fullscreen = !S.prefs.fullscreen;
    applyPrefs();
    toast(S.prefs.fullscreen ? "Full screen dial" : "Normal dial");
  }
  if(k==="escape"){ E.overlay.classList.remove("show"); }
});

document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState==="visible" && S.run && S.end){
    S.left=Math.max(0,Math.round((S.end-Date.now())/1000));
    if(S.left<=0){
      if(S.id){clearInterval(S.id);S.id=null}
      S.run=false; fire("timer");
    }
    render();
  }
});

/* ===== Init ===== */
loadStats();
loadPrefs();
applyPrefs();
pick(60);
updNotif();
render();
pwa();
showClock();
setInterval(()=>{ E.statusClock.textContent = nowHM(); }, 1000);
</script>
</body>
</html>
