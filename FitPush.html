<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="FitPush" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>FitPush - Активность во время работы</title>
  <style>
    :root {
      --bg: #f3f7f9;
      --card: #ffffff;
      --ink: #172026;
      --muted: #5f6b76;
      --line: #d9e3ea;
      --primary: #0ea5a4;
      --primary-strong: #0b8a89;
      --ok: #16a34a;
      --warn: #d97706;
      --danger: #dc2626;
      --radius: 16px;
      --shadow: 0 12px 28px rgba(23, 32, 38, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 8% -10%, #d8f3f2 0%, transparent 48%),
        radial-gradient(circle at 92% 5%, #dce9ff 0%, transparent 50%),
        var(--bg);
      min-height: 100vh;
    }

    .app {
      max-width: 920px;
      margin: 0 auto;
      padding:
        calc(20px + env(safe-area-inset-top))
        16px
        calc(28px + env(safe-area-inset-bottom));
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .title {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.01em;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .status {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 0.78rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .status.run { color: var(--ok); border-color: #86efac; background: #f0fdf4; }
    .status.pause { color: var(--warn); border-color: #fdba74; background: #fffbeb; }

    .time-wrap {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff 0%, #f6fbfb 100%);
      padding: 16px;
      text-align: center;
    }

    .label {
      margin: 0 0 8px;
      color: var(--muted);
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .clock {
      margin: 0;
      font-size: clamp(2.6rem, 6vw, 4rem);
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.03em;
    }

    .progress {
      margin-top: 12px;
      height: 12px;
      border-radius: 999px;
      background: #e8f0f4;
      overflow: hidden;
      border: 1px solid #d2dde5;
    }

    .progress > div {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #2dd4bf, #06b6d4);
      transition: width .3s linear;
    }

    .controls, .intervals {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 14px;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: transform .08s ease, background .15s ease;
    }

    button:active { transform: translateY(1px); }

    .btn-main { background: var(--primary); color: #fff; }
    .btn-main:hover { background: var(--primary-strong); }
    .btn-soft { background: #f8fafc; border-color: var(--line); color: var(--ink); }
    .btn-ok { background: #16a34a; color: #fff; }
    .btn-skip { background: #f3f4f6; color: #111827; border-color: #d1d5db; }

    .intervals button.active {
      background: #0f766e;
      color: #fff;
      border-color: #0f766e;
    }

    .activity {
      border: 1px dashed #91a5b4;
      border-radius: 14px;
      background: #f8fbfd;
      padding: 16px;
      display: none;
    }

    .activity.show { display: block; }

    .activity h3 {
      margin: 0 0 8px;
      font-size: 1.08rem;
    }

    .activity p {
      margin: 4px 0;
      color: #2c3b46;
      font-size: 0.95rem;
    }

    .activity .hint {
      color: var(--muted);
      font-size: 0.86rem;
    }

    .side {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .tile {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #f9fcfe;
    }

    .tile .v {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
    }

    .tile .k {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--line);
    }

    .row:last-child { border-bottom: none; }

    select {
      font: inherit;
      border-radius: 10px;
      padding: 7px 10px;
      border: 1px solid #c8d5df;
      background: #fff;
      min-width: 124px;
    }

    .history {
      max-height: 242px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fbfeff;
    }

    .entry {
      padding: 10px 12px;
      border-bottom: 1px solid #e3edf3;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.88rem;
    }

    .entry:last-child { border-bottom: none; }
    .entry .meta { color: var(--muted); }

    .empty {
      padding: 16px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .tip {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .ios-hint {
      display: none;
      font-size: 0.88rem;
      color: #334155;
      line-height: 1.45;
      border: 1px solid #c9d8e6;
      border-radius: 12px;
      padding: 10px 12px;
      background: #f8fbff;
    }

    .ios-hint.show { display: block; }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.58);
      padding: 16px;
      z-index: 30;
    }

    .overlay.show { display: flex; }

    .modal {
      width: min(520px, 100%);
      background: #fff;
      border: 1px solid #d5e3ed;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 20px 52px rgba(15, 23, 42, 0.3);
    }

    .modal h2 { margin: 0 0 8px; }
    .modal p { margin: 6px 0; color: #334155; }
    .modal .hint { color: var(--muted); font-size: 0.84rem; }

    .modal-actions {
      margin-top: 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 860px) {
      .app { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="card main">
      <div class="head">
        <div>
          <h1 class="title">FitPush</h1>
          <p class="subtitle">Короткие упражнения во время работы</p>
        </div>
        <div id="statusPill" class="status">Ожидание</div>
      </div>

      <div class="time-wrap">
        <p id="phaseLabel" class="label">До следующей активности</p>
        <h2 id="clock" class="clock">60:00</h2>
        <div class="progress"><div id="bar"></div></div>
      </div>

      <div class="controls">
        <button id="startBtn" class="btn-main">Старт</button>
        <button id="pauseBtn" class="btn-soft">Пауза</button>
        <button id="resetBtn" class="btn-soft">Сброс</button>
        <button id="skipBtn" class="btn-soft">Сработать сейчас</button>
      </div>

      <div class="intervals" id="intervals">
        <button data-min="25">25м</button>
        <button data-min="45">45м</button>
        <button data-min="60" class="active">60м</button>
        <button data-min="90">90м</button>
      </div>

      <section id="currentActivity" class="activity" aria-live="polite">
        <h3 id="activityTitle"></h3>
        <p id="activityDose"></p>
        <p id="activityHint" class="hint"></p>
      </section>

      <p class="tip">Горячие клавиши: <strong>S</strong> старт/пауза, <strong>R</strong> сброс, <strong>N</strong> сработать сейчас.</p>
    </section>

    <aside class="card side">
      <h3 style="margin:4px 0 2px">Сегодня</h3>
      <div class="stats">
        <div class="tile"><p id="stActivities" class="v">0</p><p class="k">Активности</p></div>
        <div class="tile"><p id="stMinutes" class="v">0</p><p class="k">Минут в движении</p></div>
        <div class="tile"><p id="stPushups" class="v">0</p><p class="k">Отжимания</p></div>
        <div class="tile"><p id="stStreak" class="v">0</p><p class="k">Дней подряд</p></div>
      </div>

      <div class="card" style="padding: 10px 12px; border-radius: 12px; box-shadow: none;">
        <div class="row">
          <div>
            <strong>Звук напоминания</strong>
          </div>
          <select id="soundSel">
            <option value="soft">Мягкий</option>
            <option value="bell" selected>Колокол</option>
            <option value="pulse">Пульс</option>
          </select>
        </div>
        <div class="row">
          <div>
            <strong>Уведомления</strong>
          </div>
          <button id="notifBtn" class="btn-soft" style="padding: 8px 10px;">Включить</button>
        </div>
      </div>

      <h3 style="margin:6px 0 2px">История активности</h3>
      <div id="history" class="history"><div class="empty">Пока нет выполненных активностей.</div></div>
      <div id="iosHint" class="ios-hint">
        Для iPhone: открой в Safari, нажми «Поделиться» и выбери «На экран Домой».
        После установки приложение запускается как отдельное и уведомления работают лучше.
      </div>
    </aside>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">Время подвигаться</h2>
      <p id="modalDose"></p>
      <p id="modalHint" class="hint"></p>
      <div class="modal-actions">
        <button id="doneBtn" class="btn-ok">Сделано</button>
        <button id="laterBtn" class="btn-skip">Пропустить</button>
      </div>
    </div>
  </div>

  <script>
    const KEY_STATS = "fitpush_stats_v2";
    const KEY_HISTORY = "fitpush_history_v2";
    const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const IS_STANDALONE = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;

    const activities = [
      { name: "Отжимания", dose: "10 повторов", hint: "Держи корпус в напряжении и полную амплитуду.", minutes: 1, pushups: 10 },
      { name: "Приседания", dose: "15 повторов", hint: "Пятки на полу, грудь выше.", minutes: 1 },
      { name: "Стульчик у стены", dose: "40 секунд", hint: "Спина плотно к стене.", minutes: 1 },
      { name: "Растяжка стоя", dose: "60 секунд", hint: "Раскрой плечи и бедра.", minutes: 1 },
      { name: "Прогулка от стола", dose: "2 минуты", hint: "Пройдись, чтобы разгрузить осанку.", minutes: 2 },
      { name: "Планка", dose: "30 секунд", hint: "Нейтральная спина, ровное дыхание.", minutes: 1 },
      { name: "Выпады", dose: "8 на каждую сторону", hint: "Колено движется по линии стопы.", minutes: 1 },
      { name: "Прыжки \"звездочка\"", dose: "30 повторов", hint: "Держи ритм, не гони скорость.", minutes: 1 }
    ];

    const state = {
      intervalMin: 60,
      totalSec: 3600,
      remainSec: 3600,
      running: false,
      timerId: null,
      endAt: null,
      current: null,
      stats: {
        date: "",
        activities: 0,
        minutesActive: 0,
        pushups: 0,
        streakDays: 0,
        lastActiveDate: ""
      },
      history: []
    };

    const el = {
      clock: document.getElementById("clock"),
      bar: document.getElementById("bar"),
      statusPill: document.getElementById("statusPill"),
      phaseLabel: document.getElementById("phaseLabel"),
      startBtn: document.getElementById("startBtn"),
      pauseBtn: document.getElementById("pauseBtn"),
      resetBtn: document.getElementById("resetBtn"),
      skipBtn: document.getElementById("skipBtn"),
      intervals: document.getElementById("intervals"),
      currentActivity: document.getElementById("currentActivity"),
      activityTitle: document.getElementById("activityTitle"),
      activityDose: document.getElementById("activityDose"),
      activityHint: document.getElementById("activityHint"),
      stActivities: document.getElementById("stActivities"),
      stMinutes: document.getElementById("stMinutes"),
      stPushups: document.getElementById("stPushups"),
      stStreak: document.getElementById("stStreak"),
      history: document.getElementById("history"),
      soundSel: document.getElementById("soundSel"),
      notifBtn: document.getElementById("notifBtn"),
      overlay: document.getElementById("overlay"),
      modalTitle: document.getElementById("modalTitle"),
      modalDose: document.getElementById("modalDose"),
      modalHint: document.getElementById("modalHint"),
      doneBtn: document.getElementById("doneBtn"),
      laterBtn: document.getElementById("laterBtn"),
      iosHint: document.getElementById("iosHint")
    };

    function formatSec(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function isoDate(d = new Date()) {
      return d.toISOString().slice(0, 10);
    }

    function loadState() {
      try {
        const rawStats = localStorage.getItem(KEY_STATS);
        const rawHistory = localStorage.getItem(KEY_HISTORY);
        if (rawStats) state.stats = { ...state.stats, ...JSON.parse(rawStats) };
        if (rawHistory) state.history = JSON.parse(rawHistory);
      } catch (_) {}

      const today = isoDate();
      if (state.stats.date !== today) {
        const prev = state.stats.date;
        state.stats.date = today;
        state.stats.activities = 0;
        state.stats.minutesActive = 0;
        state.stats.pushups = 0;

        if (prev && state.stats.lastActiveDate) {
          const prevDate = new Date(state.stats.lastActiveDate + "T00:00:00");
          const oneDay = 24 * 60 * 60 * 1000;
          const diff = Math.round((new Date(today + "T00:00:00") - prevDate) / oneDay);
          if (diff > 1) {
            state.stats.streakDays = 0;
          }
        }

        state.history = state.history.filter((entry) => entry.date === today);
      }

      persist();
    }

    function persist() {
      localStorage.setItem(KEY_STATS, JSON.stringify(state.stats));
      localStorage.setItem(KEY_HISTORY, JSON.stringify(state.history.slice(-200)));
    }

    function renderTimer() {
      el.clock.textContent = formatSec(state.remainSec);
      const ratio = Math.max(0, Math.min(1, 1 - state.remainSec / state.totalSec));
      el.bar.style.width = (ratio * 100).toFixed(2) + "%";

      if (state.running) {
        el.statusPill.textContent = "Идет";
        el.statusPill.className = "status run";
      } else if (state.remainSec !== state.totalSec) {
        el.statusPill.textContent = "Пауза";
        el.statusPill.className = "status pause";
      } else {
        el.statusPill.textContent = "Ожидание";
        el.statusPill.className = "status";
      }

      if (state.remainSec <= 60) {
        el.clock.style.color = "var(--danger)";
      } else if (state.remainSec <= 300) {
        el.clock.style.color = "var(--warn)";
      } else {
        el.clock.style.color = "var(--ink)";
      }

      document.title = state.running
        ? formatSec(state.remainSec) + " - FitPush"
        : "FitPush - Активность во время работы";
    }

    function renderStats() {
      el.stActivities.textContent = String(state.stats.activities);
      el.stMinutes.textContent = String(state.stats.minutesActive);
      el.stPushups.textContent = String(state.stats.pushups);
      el.stStreak.textContent = String(state.stats.streakDays);
    }

    function renderHistory() {
      if (!state.history.length) {
        el.history.innerHTML = '<div class="empty">Пока нет выполненных активностей.</div>';
        return;
      }

      const rows = state.history.slice().reverse().map((entry) => {
        return '<div class="entry">' +
          '<div><strong>' + escapeHtml(entry.name) + '</strong><div class="meta">' + escapeHtml(entry.dose) + '</div></div>' +
          '<div class="meta">' + escapeHtml(entry.time) + '</div>' +
        '</div>';
      });

      el.history.innerHTML = rows.join("");
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setIntervalMinutes(min) {
      state.intervalMin = min;
      state.totalSec = min * 60;
      state.remainSec = state.totalSec;
      state.endAt = null;
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
      state.running = false;
      renderTimer();
      el.phaseLabel.textContent = "До следующей активности";
    }

    function startTimer() {
      if (state.running) return;
      state.running = true;
      state.endAt = Date.now() + state.remainSec * 1000;
      el.phaseLabel.textContent = "До следующей активности";

      state.timerId = setInterval(() => {
        const left = Math.round((state.endAt - Date.now()) / 1000);
        state.remainSec = Math.max(0, left);
        renderTimer();

        if (state.remainSec <= 0) {
          clearInterval(state.timerId);
          state.timerId = null;
          state.running = false;
          triggerPrompt();
        }
      }, 250);

      renderTimer();
    }

    function pauseTimer() {
      if (!state.running) return;
      state.running = false;
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
      renderTimer();
    }

    function resetTimer() {
      pauseTimer();
      state.remainSec = state.totalSec;
      state.endAt = null;
      renderTimer();
      el.phaseLabel.textContent = "До следующей активности";
    }

    function randomActivity() {
      const i = Math.floor(Math.random() * activities.length);
      return activities[i];
    }

    function showActivity(activity) {
      el.currentActivity.classList.add("show");
      el.activityTitle.textContent = activity.name;
      el.activityDose.textContent = "Цель: " + activity.dose;
      el.activityHint.textContent = activity.hint;

      el.modalTitle.textContent = activity.name;
      el.modalDose.textContent = "Цель: " + activity.dose;
      el.modalHint.textContent = activity.hint;
      el.overlay.classList.add("show");
    }

    function hideOverlay() {
      el.overlay.classList.remove("show");
    }

    function triggerPrompt() {
      state.current = randomActivity();
      showActivity(state.current);
      playSound(el.soundSel.value);
      vibrateShort();
      pushNotification(state.current.name + " - " + state.current.dose);
      el.phaseLabel.textContent = "Сделай это упражнение сейчас";
    }

    function completeActivity() {
      if (!state.current) return;
      const now = new Date();
      const today = isoDate(now);

      state.stats.activities += 1;
      state.stats.minutesActive += state.current.minutes || 1;
      if (state.current.pushups) {
        state.stats.pushups += state.current.pushups;
      }

      if (state.stats.lastActiveDate !== today) {
        if (state.stats.lastActiveDate) {
          const prev = new Date(state.stats.lastActiveDate + "T00:00:00");
          const diff = Math.round((new Date(today + "T00:00:00") - prev) / (24 * 60 * 60 * 1000));
          if (diff === 1) {
            state.stats.streakDays += 1;
          } else if (diff > 1) {
            state.stats.streakDays = 1;
          }
        } else {
          state.stats.streakDays = 1;
        }
        state.stats.lastActiveDate = today;
      }

      state.history.push({
        date: today,
        time: now.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" }),
        name: state.current.name,
        dose: state.current.dose
      });

      persist();
      renderStats();
      renderHistory();

      state.current = null;
      hideOverlay();
      resetTimer();
      startTimer();
    }

    function skipActivity() {
      state.current = null;
      hideOverlay();
      resetTimer();
      renderStats();
      renderHistory();
    }

    function playSound(type) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;

        if (type === "soft") {
          tone(ctx, now, 660, 0.16, "sine", 0.12);
          tone(ctx, now + 0.2, 770, 0.18, "sine", 0.1);
        } else if (type === "pulse") {
          [0, 0.12, 0.24, 0.36].forEach((d, i) => tone(ctx, now + d, 320 + i * 35, 0.1, "square", 0.09));
        } else {
          tone(ctx, now, 523, 0.2, "triangle", 0.14);
          tone(ctx, now + 0.24, 659, 0.22, "triangle", 0.12);
        }
      } catch (_) {}
    }

    function tone(ctx, start, freq, dur, wave, gainValue) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = wave;
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(gainValue, start);
      gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
      osc.start(start);
      osc.stop(start + dur);
    }

    function vibrateShort() {
      try {
        if ("vibrate" in navigator) navigator.vibrate([160, 70, 160]);
      } catch (_) {}
    }

    function requestNotifications() {
      if (!("Notification" in window)) return;
      if (IS_IOS && !IS_STANDALONE) {
        alert("На iPhone сначала добавь FitPush на экран «Домой», затем открой его и включи уведомления.");
        return;
      }
      if (Notification.permission === "default") {
        Notification.requestPermission().finally(updateNotifButton);
      } else {
        updateNotifButton();
      }
    }

    function updateNotifButton() {
      if (!("Notification" in window)) {
        el.notifBtn.textContent = "Не поддерживается";
        el.notifBtn.disabled = true;
        return;
      }
      if (IS_IOS && !IS_STANDALONE) {
        el.notifBtn.textContent = "Через «Домой»";
        return;
      }
      if (Notification.permission === "granted") {
        el.notifBtn.textContent = "Включено";
      } else if (Notification.permission === "denied") {
        el.notifBtn.textContent = "Заблокировано";
      } else {
        el.notifBtn.textContent = "Включить";
      }
    }

    function pushNotification(body) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification("FitPush напоминание", { body, tag: "fitpush" });
      }
    }

    function setupIOSHint() {
      if (IS_IOS && !IS_STANDALONE) {
        el.iosHint.classList.add("show");
      }
    }

    function setupAudioUnlock() {
      const unlock = () => {
        try {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          const ctx = new Ctx();
          if (ctx.state === "suspended") ctx.resume();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          gain.gain.value = 0.0001;
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + 0.01);
          setTimeout(() => ctx.close(), 120);
        } catch (_) {}
        document.removeEventListener("touchstart", unlock);
        document.removeEventListener("click", unlock);
      };
      document.addEventListener("touchstart", unlock, { once: true });
      document.addEventListener("click", unlock, { once: true });
    }

    function setupPWA() {
      if (!("serviceWorker" in navigator)) return;
      const canRegister = location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1";
      if (!canRegister) return;
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    }

    el.startBtn.addEventListener("click", startTimer);
    el.pauseBtn.addEventListener("click", pauseTimer);
    el.resetBtn.addEventListener("click", resetTimer);
    el.skipBtn.addEventListener("click", triggerPrompt);
    el.doneBtn.addEventListener("click", completeActivity);
    el.laterBtn.addEventListener("click", skipActivity);
    el.notifBtn.addEventListener("click", requestNotifications);

    el.intervals.addEventListener("click", (event) => {
      const btn = event.target.closest("button[data-min]");
      if (!btn) return;
      const min = Number(btn.dataset.min);
      if (!Number.isFinite(min) || min <= 0) return;
      Array.from(el.intervals.querySelectorAll("button")).forEach((x) => x.classList.remove("active"));
      btn.classList.add("active");
      setIntervalMinutes(min);
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && state.running && state.endAt) {
        state.remainSec = Math.max(0, Math.round((state.endAt - Date.now()) / 1000));
        if (state.remainSec <= 0) {
          if (state.timerId) {
            clearInterval(state.timerId);
            state.timerId = null;
          }
          state.running = false;
          triggerPrompt();
        }
        renderTimer();
      }
    });

    document.addEventListener("keydown", (event) => {
      const key = event.key.toLowerCase();
      const typing = ["input", "textarea", "select"].includes((event.target && event.target.tagName || "").toLowerCase());
      if (typing) return;

      if (key === "s") {
        if (state.running) pauseTimer();
        else startTimer();
      }
      if (key === "r") {
        resetTimer();
      }
      if (key === "n") {
        triggerPrompt();
      }
      if (key === "escape") {
        hideOverlay();
      }
    });

    loadState();
    renderStats();
    renderHistory();
    renderTimer();
    updateNotifButton();
    setupIOSHint();
    setupAudioUnlock();
    setupPWA();
  </script>
</body>
</html>
